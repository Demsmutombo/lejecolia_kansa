import{M as B}from"./bootstrap-DXdCWnwj.js";import{_ as z,u as O,a as C,b as j,d as _,c as K,e as W,f as J}from"./index-CwjmzDsC.js";import{G as X,D as Y}from"./GenericModal-DhdU3Gn5.js";import{a as n,c as D,w as Z,q as P,f as ee,o as x,g as E,h as l,K as te,l as $,m as M,p as u,C as L,t as U,D as G,E as Q}from"./vendor-Bjq3GXyS.js";import{A as R}from"./ArgonSelect-Do4WPwre.js";import"./charts-D32nV7-X.js";const c=r=>(G("data-v-6a13e304"),r=r(),Q(),r),ae={class:"modal-body-scrollable"},se=c(()=>l("h6",{class:"text-sm mt-0 mb-2"},"R√©f√©rences",-1)),oe={class:"row"},le={class:"col-md-6 mb-3"},ie=c(()=>l("label",{class:"form-label"},"Article *",-1)),re={key:0,class:"text-muted"},ne={class:"col-md-6 mb-3"},ce=c(()=>l("label",{class:"form-label"},"Site *",-1)),de={key:0,class:"text-muted"},ue=c(()=>l("h6",{class:"text-sm mt-3 mb-2"},"Quantit√©",-1)),me={class:"row"},pe={class:"col-md-6 mb-3"},ve=c(()=>l("label",{class:"form-label"},"Quantit√© en Stock *",-1)),fe={class:"col-md-6 mb-3"},ge=c(()=>l("label",{class:"form-label"},"Seuil d'Alerte",-1)),he=c(()=>l("small",{class:"text-muted"},"Alerte si stock < seuil",-1)),Se=c(()=>l("h6",{class:"text-sm mt-3 mb-2"},"Tarification",-1)),be={class:"row"},_e={class:"col-md-6 mb-3"},ye=c(()=>l("label",{class:"form-label"},"Prix d'Achat",-1)),Ae={class:"col-md-6 mb-3"},xe=c(()=>l("label",{class:"form-label"},"Prix de Vente HT *",-1)),ke={key:0,class:"row"},we={class:"col-12 mb-3"},Ie={class:"alert alert-info py-2 mb-0"},$e=c(()=>l("strong",null,"Marge:",-1)),Ne={key:0,class:"text-danger"},Ve={class:"row"},Ce={class:"col-12 mb-3"},Me={__name:"StockModal",props:{stock:{type:Object,default:null},modalId:{type:String,default:"stockModal"}},emits:["save","close"],setup(r,{expose:T,emit:k}){const w=O(),g=r,y=k,v=n(null),m=n(!1),f=n([]),d=n([]),h=n(!1),I=n(!1),S=D(()=>g.stock!==null),A=D(()=>{const s=parseFloat(o.value.prixAchat)||0,e=parseFloat(o.value.prixVentHT)||0;if(s===0||e===0)return null;const t=e-s,a=t/s*100;return{montant:t,pourcentage:a}}),o=n({idStock:0,idArticle:"",idSite:"",quantiteStock:0,prixAchat:0,prixVentHT:0,seuilAlerte:10,statut:!0}),q=async()=>{h.value=!0;try{const s=w.societeId||3,e=await _.getArticlesBySociete(s);f.value=(Array.isArray(e)?e:[]).map(t=>({value:parseInt(t.idArticle,10),label:t.libelle})),console.log("‚úÖ Articles charg√©s:",f.value.length)}catch(s){console.error("‚ùå Erreur chargement articles:",s),f.value=[]}finally{h.value=!1}},F=async()=>{I.value=!0;try{const s=w.societeId||3,e=await _.getSitesBySociete(s),t=Array.isArray(e)?e:[];d.value=t.map(a=>({value:parseInt(a.idSite,10),label:a.nomSite})),console.log("‚úÖ Sites charg√©s:",d.value.length)}catch(s){console.error("‚ùå Erreur chargement sites:",s),d.value=[]}finally{I.value=!1}};Z(()=>g.stock,s=>{s?o.value={idStock:s.idStock||0,idArticle:s.idArticle?parseInt(s.idArticle,10):"",idSite:s.idSite?parseInt(s.idSite,10):"",quantiteStock:s.quantiteStock||0,prixAchat:s.prixAchat||0,prixVentHT:s.prixVentHT||0,seuilAlerte:s.seuilAlerte||10,statut:s.statut!==void 0?s.statut:!0}:N()},{immediate:!1});const N=()=>{o.value={idStock:0,idArticle:"",idSite:"",quantiteStock:0,prixAchat:0,prixVentHT:0,seuilAlerte:10,statut:!0}},H=()=>o.value.idArticle?o.value.idSite?o.value.quantiteStock===""||o.value.quantiteStock===null||o.value.quantiteStock===void 0?{valid:!1,message:"La quantit√© en stock est obligatoire"}:!o.value.prixVentHT||o.value.prixVentHT<=0?{valid:!1,message:"Le prix de vente HT doit √™tre sup√©rieur √† 0"}:{valid:!0}:{valid:!1,message:"Le site est obligatoire"}:{valid:!1,message:"L'article est obligatoire"},V=async()=>{const s=H();if(!s.valid){alert(s.message);return}m.value=!0;try{y("save",o.value)}catch(e){console.error("Erreur lors de la sauvegarde:",e)}finally{m.value=!1}};return P(()=>{q(),F()}),T({resetForm:N,show:()=>{var s;return(s=v.value)==null?void 0:s.show()},hide:()=>{var s;return(s=v.value)==null?void 0:s.hide()},close:()=>{var s;return(s=v.value)==null?void 0:s.hide()}}),(s,e)=>(x(),ee(X,{"modal-id":r.modalId,title:`${S.value?"Modifier":"Nouveau"} Stock`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":m.value,"loading-text":"Enregistrement...",onConfirm:V,ref_key:"modalRef",ref:v},{body:E(()=>[l("div",ae,[l("form",{onSubmit:te(V,["prevent"])},[se,l("div",oe,[l("div",le,[ie,u(R,{modelValue:o.value.idArticle,"onUpdate:modelValue":e[0]||(e[0]=t=>o.value.idArticle=t),options:f.value,placeholder:"S√©lectionner un article",disabled:h.value||S.value,id:"idArticle",name:"idArticle"},null,8,["modelValue","options","disabled"]),S.value?(x(),$("small",re,"Non modifiable en √©dition")):M("",!0)]),l("div",ne,[ce,u(R,{modelValue:o.value.idSite,"onUpdate:modelValue":e[1]||(e[1]=t=>o.value.idSite=t),options:d.value,placeholder:"S√©lectionner un site",disabled:I.value||S.value,id:"idSite",name:"idSite"},null,8,["modelValue","options","disabled"]),S.value?(x(),$("small",de,"Non modifiable en √©dition")):M("",!0)])]),ue,l("div",me,[l("div",pe,[ve,u(C,{modelValue:o.value.quantiteStock,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.quantiteStock=t),type:"number",step:"0.01",placeholder:"0.00","is-required":!0,id:"quantiteStock",name:"quantiteStock"},null,8,["modelValue"])]),l("div",fe,[ge,u(C,{modelValue:o.value.seuilAlerte,"onUpdate:modelValue":e[3]||(e[3]=t=>o.value.seuilAlerte=t),type:"number",step:"1",placeholder:"10",id:"seuilAlerte",name:"seuilAlerte"},null,8,["modelValue"]),he])]),Se,l("div",be,[l("div",_e,[ye,u(C,{modelValue:o.value.prixAchat,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.prixAchat=t),type:"number",step:"0.01",placeholder:"0.00",id:"prixAchat",name:"prixAchat"},null,8,["modelValue"])]),l("div",Ae,[xe,u(C,{modelValue:o.value.prixVentHT,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.prixVentHT=t),type:"number",step:"0.01",placeholder:"0.00","is-required":!0,id:"prixVentHT",name:"prixVentHT"},null,8,["modelValue"])])]),A.value!==null?(x(),$("div",ke,[l("div",we,[l("div",Ie,[$e,L(" "+U(A.value.montant.toFixed(2))+" FC ("+U(A.value.pourcentage.toFixed(1))+"%) ",1),A.value.pourcentage<0?(x(),$("span",Ne," ‚ö†Ô∏è Perte !")):M("",!0)])])])):M("",!0),l("div",Ve,[l("div",Ce,[u(j,{modelValue:o.value.statut,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.statut=t),id:"stockStatut",name:"statut"},{default:E(()=>[L(" Actif ")]),_:1},8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},Ee=z(Me,[["__scopeId","data-v-6a13e304"]]),Te=r=>(G("data-v-aea11f30"),r=r(),Q(),r),qe={class:"container-fluid py-4"},Fe={class:"row"},He={class:"col-12"},Be=Te(()=>l("i",{class:"fas fa-plus me-2"},null,-1)),Le={__name:"Stocks",setup(r){const{requireAuth:T}=K(),k=O(),{showConfirm:w,showSuccess:g,showError:y,showLoading:v,close:m}=W();T();const f=n(!1),d=n([]),h=n(null),I=n(null),S=[{key:"numero",label:"N¬∞",type:"index",align:"center"},{key:"articleNom",label:"Article",render:(e,t)=>t.articleNom||`Article #${t.idArticle}`},{key:"siteNom",label:"Site",render:(e,t)=>t.siteNom||`Site #${t.idSite}`},{key:"categorieNom",label:"Cat√©gorie",render:(e,t)=>t.categorieNom||"-"},{key:"quantiteStock",label:"Quantit√©",align:"center",render:(e,t)=>{const a=parseFloat(e)||0,i=parseInt(t.seuilAlerte,10)||0;return a===0?'<span class="badge badge-sm bg-gradient-danger">0 - Rupture</span>':i>0&&a<=i?`<span class="badge badge-sm bg-gradient-warning">${a.toFixed(2)} - Alerte !</span>`:`<span class="badge badge-sm bg-gradient-success">${a.toFixed(2)}</span>`}},{key:"seuilAlerte",label:"Seuil",align:"center",render:e=>{const t=parseInt(e,10)||0;return t>0?t:"-"}},{key:"prix",label:"Prix Achat / Vente",render:(e,t)=>{const a=parseFloat(t.prixAchat)||0,i=parseFloat(t.prixVentHT)||0;return`
        <div style="font-size: 0.75rem;">
          <span class="text-secondary">${a.toLocaleString("fr-CD",{style:"currency",currency:"CDF"})}</span> /
          <strong class="text-success">${i.toLocaleString("fr-CD",{style:"currency",currency:"CDF"})}</strong>
        </div>
      `}},{key:"marge",label:"Marge",align:"end",render:(e,t)=>{const a=parseFloat(t.prixAchat)||0,i=parseFloat(t.prixVentHT)||0;if(a===0)return"-";const b=(i-a)/a*100;return b<0?`<span class="text-danger">${b.toFixed(1)}%</span>`:b<20?`<span class="text-warning">${b.toFixed(1)}%</span>`:`<span class="text-success font-weight-bold">${b.toFixed(1)}%</span>`}},{key:"statut",label:"Statut",align:"center",render:e=>e?'<span class="badge badge-sm bg-gradient-success">Actif</span>':'<span class="badge badge-sm bg-gradient-secondary">Inactif</span>'}],A=[{name:"toggle",label:e=>e.statut?"D√©sactiver":"Activer",icon:e=>e.statut?"fas fa-toggle-on":"fas fa-toggle-off",class:e=>e.statut?"text-success":"text-secondary",onClick:e=>H(e)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:e=>N(e)},{name:"delete",label:"Supprimer",icon:"fas fa-trash",class:"text-danger",iconOnly:!0,onClick:e=>s(e)}],o=async()=>{f.value=!0,console.log("üì¶ Chargement des stocks...");try{await q();const e=d.value.filter(t=>{const a=parseFloat(t.quantiteStock)||0,i=parseInt(t.seuilAlerte,10)||0;return a===0||i>0&&a<=i});e.length>0&&console.warn(`‚ö†Ô∏è ${e.length} stock(s) en alerte !`)}catch(e){console.error("‚ùå Erreur chargement stocks:",e),await y("Erreur","Impossible de charger les stocks"),d.value=[]}finally{f.value=!1}},q=async()=>{try{const e=k.societeId||3;console.log(`üì¶ Chargement des stocks optimis√©s pour Lejecolia (#${e})`);const t=await _.getStocksVueBySociete(e);d.value=(Array.isArray(t)?t:[]).map(a=>{const i=a.articleNom||a.nomArticle||a.libelleArticle||a.libelle||a.descriptionArticle||a.article||a.designation||`Article #${a.idArticle}`,p=a.siteNom||a.nomSite||a.siteName||a.site||`Site #${a.idSite}`,b=a.categorieNom||a.nomCategorie||a.categorie||a.libelleCategorie||"";return{...a,articleNom:i,siteNom:p,categorieNom:b}}),console.log(`‚úÖ ${d.value.length} stock(s) trouv√©s pour la soci√©t√©`)}catch(e){throw console.warn("‚ö†Ô∏è Impossible de charger les stocks:",e),e}},F=()=>{h.value=null,new B(document.getElementById("stockModal")).show()},N=e=>{h.value={...e},new B(document.getElementById("stockModal")).show()},H=async e=>{const t=!e.statut,a=t?"activer":"d√©sactiver";if((await w(`${a.charAt(0).toUpperCase()+a.slice(1)} ?`,`Voulez-vous ${a} le stock de ${e.articleNom} ?`,{confirmButtonText:`Oui, ${a}`,confirmButtonColor:t?"#2dce89":"#f5365c"})).isConfirmed){v(`${a.charAt(0).toUpperCase()+a.slice(1)}...`);try{const p={...e,statut:t,idSociete:k.societeId||3};await _.updateStock(e.idStock,p),m(),await g("Modifi√© !",`Stock ${t?"activ√©":"d√©sactiv√©"}`),await o()}catch(p){m(),console.error("‚ùå Erreur:",p),await y("Erreur","Impossible de modifier le statut")}}},V=async e=>{var t,a;v("Enregistrement...");try{const i={...e,idSociete:k.societeId||3};e.idStock&&e.idStock>0?(await _.updateStock(e.idStock,i),await g("Modifi√© !","Stock modifi√©")):(await _.createStock(i),await g("Cr√©√© !","Stock cr√©√©"));const p=B.getInstance(document.getElementById("stockModal"));p&&p.hide(),await o()}catch(i){m(),console.error("‚ùå Erreur:",i),await y("Erreur",((a=(t=i.response)==null?void 0:t.data)==null?void 0:a.message)||"Erreur de sauvegarde")}},s=async e=>{if((await w("Supprimer ?",`Supprimer le stock de ${e.articleNom} au site ${e.siteNom} ?`,{confirmButtonText:"Oui, supprimer",confirmButtonColor:"#d33"})).isConfirmed){v("Suppression...");try{await _.deleteStock(e.idStock),m(),await g("Supprim√© !"),await o()}catch{m(),await y("Erreur","Impossible de supprimer")}}};return P(()=>{o()}),(e,t)=>(x(),$("div",qe,[l("div",Fe,[l("div",He,[u(Y,{title:"Gestion des Stocks",subtitle:"Inventaire et tarification des articles",data:d.value,columns:S,actions:A,"show-search":!0,"search-fields":["articleNom","siteNom"],loading:f.value,"items-per-page":10,"loading-text":"Chargement des stocks...","empty-text":"Aucun stock trouv√©"},{actions:E(()=>[u(J,{color:"success",size:"sm",onClick:F},{default:E(()=>[Be,L(" Nouveau Stock ")]),_:1})]),_:1},8,["data","loading"])])]),u(Ee,{stock:h.value,"modal-id":"stockModal",onSave:V,ref_key:"stockModalRef",ref:I},null,8,["stock"])]))}},Ge=z(Le,[["__scopeId","data-v-aea11f30"]]);export{Ge as default};
