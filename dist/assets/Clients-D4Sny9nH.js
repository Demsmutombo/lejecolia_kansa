import{M as D}from"./bootstrap-DXdCWnwj.js";import{_ as j,u as P,a as c,b as K,g as Q,c as H,d as S,e as W,f as X}from"./index-C7KYosbF.js";import{G as Y,D as Z}from"./GenericModal-D2OVyllk.js";import{c as T,a as f,w as G,f as ee,o as F,g as w,h as t,I as le,p as u,C as z,q as te,l as oe,t as ae}from"./vendor-5ChSB122.js";import{A as O}from"./ArgonSelect-BIJzuYL2.js";import"./charts-D32nV7-X.js";const se={class:"modal-body-scrollable"},ne={class:"row"},ie={class:"col-md-6 mb-3"},re={class:"col-md-6 mb-3"},de={class:"row"},ue={class:"col-12 mb-3"},me={class:"row"},ce={class:"col-12 mb-3"},pe={class:"row"},ve={class:"col-md-6 mb-3"},fe={class:"col-md-6 mb-3"},ge={class:"row"},be={class:"col-md-4 mb-3"},Ce={class:"col-md-4 mb-3"},Se={class:"col-md-4 mb-3"},ye={class:"row"},he={class:"col-md-4 mb-3"},$e={class:"col-md-4 mb-3"},xe={class:"col-md-4 mb-3"},Ee={class:"row"},Ve={class:"col-12 mb-3"},we={__name:"ClientModal",props:{client:{type:Object,default:null},modalId:{type:String,default:"clientModal"}},emits:["save","close"],setup(q,{expose:B,emit:I}){const M=P(),p=T(()=>M.societeId),g=q,E=I,m=f(null),b=f(!1),y=T(()=>g.client!==null),V=[{value:"Masculin",label:"Masculin"},{value:"FÃ©minin",label:"FÃ©minin"},{value:"Non prÃ©cisÃ©",label:"Non prÃ©cisÃ©"}],v=f([]),A=async()=>{if(!p.value){v.value=[];return}try{console.log("ðŸ¢ Chargement des sites pour ClientModal...");const a=await Q(p.value);let e=Array.isArray(a)?a:[];console.log(`ðŸ“‹ ${e.length} site(s) reÃ§us pour la sociÃ©tÃ© #${p.value}`),v.value=e.map(s=>({value:parseInt(s.idSite,10),label:s.nomSite||s.nom||"Site sans nom"})),console.log("âœ… Sites formatÃ©s pour le select:",v.value)}catch(a){console.error("âŒ Erreur chargement sites:",a),v.value=[]}};G(p,()=>{A()},{immediate:!0});const o=f({idClient:0,nom:"",prenom:"",genre:"Non prÃ©cisÃ©",email:"",telephone:"",idSite:0,province:"",ville:"",commune:"",quartier:"",avenue:"",numero:"",statut:!0});G(()=>g.client,a=>{a?o.value={idClient:a.idClient||0,nom:a.nom||"",prenom:a.prenom||"",genre:a.genre||"Non prÃ©cisÃ©",email:a.email||"",telephone:a.telephone||"",idSite:a.idSite?parseInt(a.idSite,10):0,province:a.province||"",ville:a.ville||"",commune:a.commune||"",quartier:a.quartier||"",avenue:a.avenue||"",numero:a.numero||"",statut:a.statut!==void 0?a.statut:!0}:_(),A()},{immediate:!1});const _=()=>{o.value={idClient:0,nom:"",prenom:"",genre:"Non prÃ©cisÃ©",email:"",telephone:"",idSite:v.value.length?v.value[0].value:0,province:"",ville:"",commune:"",quartier:"",avenue:"",numero:"",statut:!0}},h=()=>!o.value.nom||!o.value.nom.trim()?{valid:!1,message:"Le nom est obligatoire"}:!o.value.prenom||!o.value.prenom.trim()?{valid:!1,message:"Le prÃ©nom est obligatoire"}:!o.value.telephone||!o.value.telephone.trim()?{valid:!1,message:"Le tÃ©lÃ©phone est obligatoire"}:!o.value.idSite||parseInt(o.value.idSite,10)===0?{valid:!1,message:"Le site est obligatoire"}:{valid:!0},k=async()=>{const a=h();if(!a.valid){alert(a.message);return}b.value=!0;try{E("save",{...o.value,idSite:parseInt(o.value.idSite,10)})}catch(e){console.error("Erreur lors de la sauvegarde:",e)}finally{b.value=!1}};return B({resetForm:_,show:()=>{var a;return(a=m.value)==null?void 0:a.show()},hide:()=>{var a;return(a=m.value)==null?void 0:a.hide()},close:()=>{var a;return(a=m.value)==null?void 0:a.hide()}}),(a,e)=>(F(),ee(Y,{"modal-id":q.modalId,title:`${y.value?"Modifier":"Nouveau"} Client`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":b.value,"loading-text":"Enregistrement...",onConfirm:k,ref_key:"modalRef",ref:m},{body:w(()=>[t("div",se,[t("form",{onSubmit:le(k,["prevent"])},[e[26]||(e[26]=t("h6",{class:"text-sm mt-0 mb-2"},"IdentitÃ©",-1)),t("div",ne,[t("div",ie,[e[13]||(e[13]=t("label",{class:"form-label"},"Nom *",-1)),u(c,{modelValue:o.value.nom,"onUpdate:modelValue":e[0]||(e[0]=s=>o.value.nom=s),placeholder:"Ex: DUPONT","is-required":!0,id:"nom",name:"nom"},null,8,["modelValue"])]),t("div",re,[e[14]||(e[14]=t("label",{class:"form-label"},"PrÃ©nom *",-1)),u(c,{modelValue:o.value.prenom,"onUpdate:modelValue":e[1]||(e[1]=s=>o.value.prenom=s),placeholder:"Ex: Jean","is-required":!0,id:"prenom",name:"prenom"},null,8,["modelValue"])])]),t("div",de,[t("div",ue,[e[15]||(e[15]=t("label",{class:"form-label"},"Site *",-1)),u(O,{modelValue:o.value.idSite,"onUpdate:modelValue":e[2]||(e[2]=s=>o.value.idSite=s),options:v.value,placeholder:"SÃ©lectionner un site",id:"site",name:"site","is-required":!0},null,8,["modelValue","options"])])]),t("div",me,[t("div",ce,[e[16]||(e[16]=t("label",{class:"form-label"},"Genre",-1)),u(O,{modelValue:o.value.genre,"onUpdate:modelValue":e[3]||(e[3]=s=>o.value.genre=s),options:V,placeholder:"SÃ©lectionner",id:"genre",name:"genre"},null,8,["modelValue"])])]),e[27]||(e[27]=t("h6",{class:"text-sm mt-3 mb-2"},"Contact",-1)),t("div",pe,[t("div",ve,[e[17]||(e[17]=t("label",{class:"form-label"},"TÃ©lÃ©phone *",-1)),u(c,{modelValue:o.value.telephone,"onUpdate:modelValue":e[4]||(e[4]=s=>o.value.telephone=s),placeholder:"+243 123 456 789","is-required":!0,id:"telephone",name:"telephone"},null,8,["modelValue"])]),t("div",fe,[e[18]||(e[18]=t("label",{class:"form-label"},"Email",-1)),u(c,{modelValue:o.value.email,"onUpdate:modelValue":e[5]||(e[5]=s=>o.value.email=s),type:"email",placeholder:"email@example.com",id:"email",name:"email"},null,8,["modelValue"])])]),e[28]||(e[28]=t("h6",{class:"text-sm mt-3 mb-2"},"Adresse",-1)),t("div",ge,[t("div",be,[e[19]||(e[19]=t("label",{class:"form-label"},"Province",-1)),u(c,{modelValue:o.value.province,"onUpdate:modelValue":e[6]||(e[6]=s=>o.value.province=s),placeholder:"Ex: Kinshasa",id:"province",name:"province"},null,8,["modelValue"])]),t("div",Ce,[e[20]||(e[20]=t("label",{class:"form-label"},"Ville",-1)),u(c,{modelValue:o.value.ville,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value.ville=s),placeholder:"Ex: Kinshasa",id:"ville",name:"ville"},null,8,["modelValue"])]),t("div",Se,[e[21]||(e[21]=t("label",{class:"form-label"},"Commune",-1)),u(c,{modelValue:o.value.commune,"onUpdate:modelValue":e[8]||(e[8]=s=>o.value.commune=s),placeholder:"Ex: Gombe",id:"commune",name:"commune"},null,8,["modelValue"])])]),t("div",ye,[t("div",he,[e[22]||(e[22]=t("label",{class:"form-label"},"Quartier",-1)),u(c,{modelValue:o.value.quartier,"onUpdate:modelValue":e[9]||(e[9]=s=>o.value.quartier=s),placeholder:"Ex: Centre-ville",id:"quartier",name:"quartier"},null,8,["modelValue"])]),t("div",$e,[e[23]||(e[23]=t("label",{class:"form-label"},"Avenue",-1)),u(c,{modelValue:o.value.avenue,"onUpdate:modelValue":e[10]||(e[10]=s=>o.value.avenue=s),placeholder:"Ex: Avenue de la Paix",id:"avenue",name:"avenue"},null,8,["modelValue"])]),t("div",xe,[e[24]||(e[24]=t("label",{class:"form-label"},"NumÃ©ro",-1)),u(c,{modelValue:o.value.numero,"onUpdate:modelValue":e[11]||(e[11]=s=>o.value.numero=s),placeholder:"Ex: 123",id:"numero",name:"numero"},null,8,["modelValue"])])]),t("div",Ee,[t("div",Ve,[u(K,{modelValue:o.value.statut,"onUpdate:modelValue":e[12]||(e[12]=s=>o.value.statut=s),id:"clientStatut",name:"statut"},{default:w(()=>[...e[25]||(e[25]=[z(" Client actif ",-1)])]),_:1},8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},Ie=j(we,[["__scopeId","data-v-c5e4cc4a"]]),Me={class:"container-fluid py-4"},Ae={class:"row"},_e={class:"col-12"},ke={class:"mb-0 text-sm font-weight-bold"},Ue={__name:"Clients",setup(q){const{requireAuth:B}=H(),I=P(),{showConfirm:M,showSuccess:p,showError:g,showLoading:E,close:m}=W();B();const b=f(!1),y=f([]),V=f(null),v=f(null),A=T(()=>{const l=y.value.length;return`${l} client${l>1?"s":""} - Lejecolia`}),o=[{key:"idClient",label:"NÂ°",type:"index",align:"center"},{key:"nomComplet",label:"Client",render:(l,n)=>{if(l&&l!=="-")return l;const i=n.nom||"",r=n.prenom||"";return`${i} ${r}`.trim()||"-"}},{key:"genre",label:"Genre",align:"center",render:l=>l==="Masculin"?'<span class="badge badge-sm bg-gradient-info">M</span>':l==="FÃ©minin"?'<span class="badge badge-sm bg-gradient-danger">F</span>':'<span class="badge badge-sm bg-gradient-secondary">-</span>'},{key:"email",label:"Email",render:l=>l||"-"},{key:"telephone",label:"TÃ©lÃ©phone",render:l=>l||"-"},{key:"adresse",label:"Adresse",render:(l,n)=>{const i=n.adresseClient||l;if(i&&i!=="-")return i;const r=[];return n.commune&&r.push(n.commune),n.ville&&r.push(n.ville),r.length>0?r.join(", "):"-"}},{key:"nomSite",label:"Site",render:l=>l||"-"}],_=[{name:"toggle",label:l=>l.statut?"DÃ©sactiver":"Activer",icon:l=>l.statut?"fas fa-toggle-on":"fas fa-toggle-off",class:l=>l.statut?"text-success":"text-secondary",onClick:l=>s(l)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:l=>a(l)},{name:"delete",label:"Supprimer",icon:"fas fa-trash",class:"text-danger",iconOnly:!0,onClick:l=>R(l)}],h=async()=>{b.value=!0,console.log("ðŸ“¡ Chargement des clients Lejecolia...");try{const l=I.societeId||3;let n=[];console.log(`ðŸ“Š GET /api/V_ClientsParSite/societe/${l}`);try{n=await S.getClientsParSiteBySociete(l),console.log(`âœ… ${Array.isArray(n)?n.length:0} client(s) rÃ©cupÃ©rÃ©s`)}catch(i){console.warn("âš ï¸ Erreur avec la vue optimisÃ©e, fallback vers /api/Clients"),console.error("DÃ©tails:",i);const r=await S.getClients(),$=await S.getSitesBySociete(l),C=new Set((Array.isArray($)?$:[]).map(x=>parseInt(x.idSite,10)));n=(Array.isArray(r)?r:[]).filter(x=>{const U=parseInt(x.idSite,10);return C.has(U)}),console.log(`âœ… ${n.length} client(s) aprÃ¨s filtrage manuel`)}y.value=Array.isArray(n)?n:[]}catch(l){console.error("âŒ Erreur chargement clients:",l),await g("Erreur","Impossible de charger les clients Lejecolia"),y.value=[]}finally{b.value=!1}},k=()=>{V.value=null,new D(document.getElementById("clientModal")).show()},a=l=>{V.value={...l},new D(document.getElementById("clientModal")).show()},e=async l=>{var n,i,r,$,C,x,U;E("Enregistrement...");try{const d={...l,idSociete:I.societeId||3};console.log("ðŸ’¾ DonnÃ©es client Ã  sauvegarder:",d),console.log("ðŸ¢ Site sÃ©lectionnÃ©:",d.idSite);const N=`${d.prenom||""} ${d.nom||""}`.trim();if(d.idClient&&d.idClient>0)await S.updateClient(d.idClient,d),await p("ModifiÃ© !",`Client ${N} modifiÃ© avec succÃ¨s`);else{const J=await S.createClient(d);console.log("âœ… Client crÃ©Ã©:",J),await p("CrÃ©Ã© !",`Client ${N} ajoutÃ© Ã  votre sociÃ©tÃ©`)}const L=D.getInstance(document.getElementById("clientModal"));L&&L.hide(),await h()}catch(d){m(),console.error("âŒ Erreur:",d),console.error("âŒ DÃ©tails de la rÃ©ponse:",(n=d.response)==null?void 0:n.data),console.error("âŒ Status:",(i=d.response)==null?void 0:i.status);const N=(($=(r=d.response)==null?void 0:r.data)==null?void 0:$.message)||((x=(C=d.response)==null?void 0:C.data)==null?void 0:x.errors)||((U=d.response)==null?void 0:U.data)||"Erreur de sauvegarde";await g("Erreur",JSON.stringify(N))}},s=async l=>{const n=!l.statut,i=n?"activer":"dÃ©sactiver",r=l.nomComplet||`${l.prenom||""} ${l.nom||""}`.trim()||"ce client";if((await M(`${i.charAt(0).toUpperCase()+i.slice(1)} ?`,`Voulez-vous ${i} ${r} ?`,{confirmButtonText:`Oui, ${i}`,confirmButtonColor:n?"#2dce89":"#f5365c"})).isConfirmed){E(`${i.charAt(0).toUpperCase()+i.slice(1)}...`);try{const C={...l,statut:n};await S.updateClient(l.idClient,C),m(),await p("Statut modifiÃ© !",`${r} est maintenant ${n?"actif":"inactif"}`),await h()}catch{m(),await g("Erreur","Impossible de modifier le statut")}}},R=async l=>{const n=l.nomComplet||`${l.prenom||""} ${l.nom||""}`.trim()||"ce client";if((await M("Supprimer ?",`Supprimer ${n} dÃ©finitivement ?`,{confirmButtonText:"Oui, supprimer",confirmButtonColor:"#d33"})).isConfirmed){E("Suppression...");try{await S.deleteClient(l.idClient),m(),await p("SupprimÃ© !",`${n} a Ã©tÃ© supprimÃ©`),await h()}catch{m(),await g("Erreur","Impossible de supprimer ce client")}}};return te(()=>{h()}),(l,n)=>(F(),oe("div",Me,[t("div",Ae,[t("div",_e,[u(Z,{title:"Gestion des Clients",subtitle:A.value,data:y.value,columns:o,actions:_,"show-search":!0,"search-fields":["nomComplet","telephone","email","nomSite"],loading:b.value,"items-per-page":10,"loading-text":"Chargement des clients...","empty-text":"Aucun client trouvÃ© pour votre sociÃ©tÃ©"},{actions:w(()=>[u(X,{color:"success",size:"sm",onClick:k},{default:w(()=>[...n[0]||(n[0]=[t("i",{class:"fas fa-user-plus me-2"},null,-1),z(" Nouveau Client ",-1)])]),_:1})]),"cell-nomComplet":w(({value:i})=>[t("div",null,[t("h6",ke,ae(i),1)])]),_:1},8,["subtitle","data","loading"])])]),u(Ie,{client:V.value,"modal-id":"clientModal",onSave:e,ref_key:"clientModalRef",ref:v},null,8,["client"])]))}},Ge=j(Ue,[["__scopeId","data-v-6cf049ae"]]);export{Ge as default};
