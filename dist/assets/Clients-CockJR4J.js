import{M as T}from"./bootstrap-DXdCWnwj.js";import{_ as P,u as F,a as v,b as W,g as X,c as Y,d as C,e as Z,f as ee}from"./index-CwjmzDsC.js";import{G as te,D as le}from"./GenericModal-DhdU3Gn5.js";import{c as L,a as g,w as O,f as oe,o as z,g as V,h as t,K as ae,p as c,C as R,D as K,E as J,q as se,l as ne,t as ie}from"./vendor-Bjq3GXyS.js";import{A as j}from"./ArgonSelect-Do4WPwre.js";import"./charts-D32nV7-X.js";const u=m=>(K("data-v-c5e4cc4a"),m=m(),J(),m),re={class:"modal-body-scrollable"},de=u(()=>t("h6",{class:"text-sm mt-0 mb-2"},"IdentitÃ©",-1)),ce={class:"row"},ue={class:"col-md-6 mb-3"},me=u(()=>t("label",{class:"form-label"},"Nom *",-1)),pe={class:"col-md-6 mb-3"},ve=u(()=>t("label",{class:"form-label"},"PrÃ©nom *",-1)),fe={class:"row"},he={class:"col-12 mb-3"},ge=u(()=>t("label",{class:"form-label"},"Site *",-1)),_e={class:"row"},be={class:"col-12 mb-3"},Se=u(()=>t("label",{class:"form-label"},"Genre",-1)),Ce=u(()=>t("h6",{class:"text-sm mt-3 mb-2"},"Contact",-1)),ye={class:"row"},$e={class:"col-md-6 mb-3"},Ee=u(()=>t("label",{class:"form-label"},"TÃ©lÃ©phone *",-1)),xe={class:"col-md-6 mb-3"},we=u(()=>t("label",{class:"form-label"},"Email",-1)),Ie=u(()=>t("h6",{class:"text-sm mt-3 mb-2"},"Adresse",-1)),Ve={class:"row"},Me={class:"col-md-4 mb-3"},Ae=u(()=>t("label",{class:"form-label"},"Province",-1)),ke={class:"col-md-4 mb-3"},Ue=u(()=>t("label",{class:"form-label"},"Ville",-1)),Ne={class:"col-md-4 mb-3"},qe=u(()=>t("label",{class:"form-label"},"Commune",-1)),Be={class:"row"},De={class:"col-md-4 mb-3"},Te=u(()=>t("label",{class:"form-label"},"Quartier",-1)),Le={class:"col-md-4 mb-3"},Ge=u(()=>t("label",{class:"form-label"},"Avenue",-1)),Oe={class:"col-md-4 mb-3"},je=u(()=>t("label",{class:"form-label"},"NumÃ©ro",-1)),Pe={class:"row"},Fe={class:"col-12 mb-3"},ze={__name:"ClientModal",props:{client:{type:Object,default:null},modalId:{type:String,default:"clientModal"}},emits:["save","close"],setup(m,{expose:D,emit:M}){const A=F(),f=L(()=>A.societeId),_=m,w=M,p=g(null),b=g(!1),y=L(()=>_.client!==null),I=[{value:"Masculin",label:"Masculin"},{value:"FÃ©minin",label:"FÃ©minin"},{value:"Non prÃ©cisÃ©",label:"Non prÃ©cisÃ©"}],h=g([]),k=async()=>{if(!f.value){h.value=[];return}try{console.log("ðŸ¢ Chargement des sites pour ClientModal...");const o=await X(f.value);let a=Array.isArray(o)?o:[];console.log(`ðŸ“‹ ${a.length} site(s) reÃ§us pour la sociÃ©tÃ© #${f.value}`),h.value=a.map(s=>({value:parseInt(s.idSite,10),label:s.nomSite||s.nom||"Site sans nom"})),console.log("âœ… Sites formatÃ©s pour le select:",h.value)}catch(o){console.error("âŒ Erreur chargement sites:",o),h.value=[]}};O(f,()=>{k()},{immediate:!0});const l=g({idClient:0,nom:"",prenom:"",genre:"Non prÃ©cisÃ©",email:"",telephone:"",idSite:0,province:"",ville:"",commune:"",quartier:"",avenue:"",numero:"",statut:!0});O(()=>_.client,o=>{o?l.value={idClient:o.idClient||0,nom:o.nom||"",prenom:o.prenom||"",genre:o.genre||"Non prÃ©cisÃ©",email:o.email||"",telephone:o.telephone||"",idSite:o.idSite?parseInt(o.idSite,10):0,province:o.province||"",ville:o.ville||"",commune:o.commune||"",quartier:o.quartier||"",avenue:o.avenue||"",numero:o.numero||"",statut:o.statut!==void 0?o.statut:!0}:U(),k()},{immediate:!1});const U=()=>{l.value={idClient:0,nom:"",prenom:"",genre:"Non prÃ©cisÃ©",email:"",telephone:"",idSite:h.value.length?h.value[0].value:0,province:"",ville:"",commune:"",quartier:"",avenue:"",numero:"",statut:!0}},$=()=>!l.value.nom||!l.value.nom.trim()?{valid:!1,message:"Le nom est obligatoire"}:!l.value.prenom||!l.value.prenom.trim()?{valid:!1,message:"Le prÃ©nom est obligatoire"}:!l.value.telephone||!l.value.telephone.trim()?{valid:!1,message:"Le tÃ©lÃ©phone est obligatoire"}:!l.value.idSite||parseInt(l.value.idSite,10)===0?{valid:!1,message:"Le site est obligatoire"}:{valid:!0},N=async()=>{const o=$();if(!o.valid){alert(o.message);return}b.value=!0;try{w("save",{...l.value,idSite:parseInt(l.value.idSite,10)})}catch(a){console.error("Erreur lors de la sauvegarde:",a)}finally{b.value=!1}};return D({resetForm:U,show:()=>{var o;return(o=p.value)==null?void 0:o.show()},hide:()=>{var o;return(o=p.value)==null?void 0:o.hide()},close:()=>{var o;return(o=p.value)==null?void 0:o.hide()}}),(o,a)=>(z(),oe(te,{"modal-id":m.modalId,title:`${y.value?"Modifier":"Nouveau"} Client`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":b.value,"loading-text":"Enregistrement...",onConfirm:N,ref_key:"modalRef",ref:p},{body:V(()=>[t("div",re,[t("form",{onSubmit:ae(N,["prevent"])},[de,t("div",ce,[t("div",ue,[me,c(v,{modelValue:l.value.nom,"onUpdate:modelValue":a[0]||(a[0]=s=>l.value.nom=s),placeholder:"Ex: DUPONT","is-required":!0,id:"nom",name:"nom"},null,8,["modelValue"])]),t("div",pe,[ve,c(v,{modelValue:l.value.prenom,"onUpdate:modelValue":a[1]||(a[1]=s=>l.value.prenom=s),placeholder:"Ex: Jean","is-required":!0,id:"prenom",name:"prenom"},null,8,["modelValue"])])]),t("div",fe,[t("div",he,[ge,c(j,{modelValue:l.value.idSite,"onUpdate:modelValue":a[2]||(a[2]=s=>l.value.idSite=s),options:h.value,placeholder:"SÃ©lectionner un site",id:"site",name:"site","is-required":!0},null,8,["modelValue","options"])])]),t("div",_e,[t("div",be,[Se,c(j,{modelValue:l.value.genre,"onUpdate:modelValue":a[3]||(a[3]=s=>l.value.genre=s),options:I,placeholder:"SÃ©lectionner",id:"genre",name:"genre"},null,8,["modelValue"])])]),Ce,t("div",ye,[t("div",$e,[Ee,c(v,{modelValue:l.value.telephone,"onUpdate:modelValue":a[4]||(a[4]=s=>l.value.telephone=s),placeholder:"+243 123 456 789","is-required":!0,id:"telephone",name:"telephone"},null,8,["modelValue"])]),t("div",xe,[we,c(v,{modelValue:l.value.email,"onUpdate:modelValue":a[5]||(a[5]=s=>l.value.email=s),type:"email",placeholder:"email@example.com",id:"email",name:"email"},null,8,["modelValue"])])]),Ie,t("div",Ve,[t("div",Me,[Ae,c(v,{modelValue:l.value.province,"onUpdate:modelValue":a[6]||(a[6]=s=>l.value.province=s),placeholder:"Ex: Kinshasa",id:"province",name:"province"},null,8,["modelValue"])]),t("div",ke,[Ue,c(v,{modelValue:l.value.ville,"onUpdate:modelValue":a[7]||(a[7]=s=>l.value.ville=s),placeholder:"Ex: Kinshasa",id:"ville",name:"ville"},null,8,["modelValue"])]),t("div",Ne,[qe,c(v,{modelValue:l.value.commune,"onUpdate:modelValue":a[8]||(a[8]=s=>l.value.commune=s),placeholder:"Ex: Gombe",id:"commune",name:"commune"},null,8,["modelValue"])])]),t("div",Be,[t("div",De,[Te,c(v,{modelValue:l.value.quartier,"onUpdate:modelValue":a[9]||(a[9]=s=>l.value.quartier=s),placeholder:"Ex: Centre-ville",id:"quartier",name:"quartier"},null,8,["modelValue"])]),t("div",Le,[Ge,c(v,{modelValue:l.value.avenue,"onUpdate:modelValue":a[10]||(a[10]=s=>l.value.avenue=s),placeholder:"Ex: Avenue de la Paix",id:"avenue",name:"avenue"},null,8,["modelValue"])]),t("div",Oe,[je,c(v,{modelValue:l.value.numero,"onUpdate:modelValue":a[11]||(a[11]=s=>l.value.numero=s),placeholder:"Ex: 123",id:"numero",name:"numero"},null,8,["modelValue"])])]),t("div",Pe,[t("div",Fe,[c(W,{modelValue:l.value.statut,"onUpdate:modelValue":a[12]||(a[12]=s=>l.value.statut=s),id:"clientStatut",name:"statut"},{default:V(()=>[R(" Client actif ")]),_:1},8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},Re=P(ze,[["__scopeId","data-v-c5e4cc4a"]]),Ke=m=>(K("data-v-6cf049ae"),m=m(),J(),m),Je={class:"container-fluid py-4"},Qe={class:"row"},He={class:"col-12"},We=Ke(()=>t("i",{class:"fas fa-user-plus me-2"},null,-1)),Xe={class:"mb-0 text-sm font-weight-bold"},Ye={__name:"Clients",setup(m){const{requireAuth:D}=Y(),M=F(),{showConfirm:A,showSuccess:f,showError:_,showLoading:w,close:p}=Z();D();const b=g(!1),y=g([]),I=g(null),h=g(null),k=L(()=>{const e=y.value.length;return`${e} client${e>1?"s":""} - Lejecolia`}),l=[{key:"idClient",label:"NÂ°",type:"index",align:"center"},{key:"nomComplet",label:"Client",render:(e,n)=>{if(e&&e!=="-")return e;const i=n.nom||"",r=n.prenom||"";return`${i} ${r}`.trim()||"-"}},{key:"genre",label:"Genre",align:"center",render:e=>e==="Masculin"?'<span class="badge badge-sm bg-gradient-info">M</span>':e==="FÃ©minin"?'<span class="badge badge-sm bg-gradient-danger">F</span>':'<span class="badge badge-sm bg-gradient-secondary">-</span>'},{key:"email",label:"Email",render:e=>e||"-"},{key:"telephone",label:"TÃ©lÃ©phone",render:e=>e||"-"},{key:"adresse",label:"Adresse",render:(e,n)=>{const i=n.adresseClient||e;if(i&&i!=="-")return i;const r=[];return n.commune&&r.push(n.commune),n.ville&&r.push(n.ville),r.length>0?r.join(", "):"-"}},{key:"nomSite",label:"Site",render:e=>e||"-"}],U=[{name:"toggle",label:e=>e.statut?"DÃ©sactiver":"Activer",icon:e=>e.statut?"fas fa-toggle-on":"fas fa-toggle-off",class:e=>e.statut?"text-success":"text-secondary",onClick:e=>s(e)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:e=>o(e)},{name:"delete",label:"Supprimer",icon:"fas fa-trash",class:"text-danger",iconOnly:!0,onClick:e=>Q(e)}],$=async()=>{b.value=!0,console.log("ðŸ“¡ Chargement des clients Lejecolia...");try{const e=M.societeId||3;let n=[];console.log(`ðŸ“Š GET /api/V_ClientsParSite/societe/${e}`);try{n=await C.getClientsParSiteBySociete(e),console.log(`âœ… ${Array.isArray(n)?n.length:0} client(s) rÃ©cupÃ©rÃ©s`)}catch(i){console.warn("âš ï¸ Erreur avec la vue optimisÃ©e, fallback vers /api/Clients"),console.error("DÃ©tails:",i);const r=await C.getClients(),E=await C.getSitesBySociete(e),S=new Set((Array.isArray(E)?E:[]).map(x=>parseInt(x.idSite,10)));n=(Array.isArray(r)?r:[]).filter(x=>{const q=parseInt(x.idSite,10);return S.has(q)}),console.log(`âœ… ${n.length} client(s) aprÃ¨s filtrage manuel`)}y.value=Array.isArray(n)?n:[]}catch(e){console.error("âŒ Erreur chargement clients:",e),await _("Erreur","Impossible de charger les clients Lejecolia"),y.value=[]}finally{b.value=!1}},N=()=>{I.value=null,new T(document.getElementById("clientModal")).show()},o=e=>{I.value={...e},new T(document.getElementById("clientModal")).show()},a=async e=>{var n,i,r,E,S,x,q;w("Enregistrement...");try{const d={...e,idSociete:M.societeId||3};console.log("ðŸ’¾ DonnÃ©es client Ã  sauvegarder:",d),console.log("ðŸ¢ Site sÃ©lectionnÃ©:",d.idSite);const B=`${d.prenom||""} ${d.nom||""}`.trim();if(d.idClient&&d.idClient>0)await C.updateClient(d.idClient,d),await f("ModifiÃ© !",`Client ${B} modifiÃ© avec succÃ¨s`);else{const H=await C.createClient(d);console.log("âœ… Client crÃ©Ã©:",H),await f("CrÃ©Ã© !",`Client ${B} ajoutÃ© Ã  votre sociÃ©tÃ©`)}const G=T.getInstance(document.getElementById("clientModal"));G&&G.hide(),await $()}catch(d){p(),console.error("âŒ Erreur:",d),console.error("âŒ DÃ©tails de la rÃ©ponse:",(n=d.response)==null?void 0:n.data),console.error("âŒ Status:",(i=d.response)==null?void 0:i.status);const B=((E=(r=d.response)==null?void 0:r.data)==null?void 0:E.message)||((x=(S=d.response)==null?void 0:S.data)==null?void 0:x.errors)||((q=d.response)==null?void 0:q.data)||"Erreur de sauvegarde";await _("Erreur",JSON.stringify(B))}},s=async e=>{const n=!e.statut,i=n?"activer":"dÃ©sactiver",r=e.nomComplet||`${e.prenom||""} ${e.nom||""}`.trim()||"ce client";if((await A(`${i.charAt(0).toUpperCase()+i.slice(1)} ?`,`Voulez-vous ${i} ${r} ?`,{confirmButtonText:`Oui, ${i}`,confirmButtonColor:n?"#2dce89":"#f5365c"})).isConfirmed){w(`${i.charAt(0).toUpperCase()+i.slice(1)}...`);try{const S={...e,statut:n};await C.updateClient(e.idClient,S),p(),await f("Statut modifiÃ© !",`${r} est maintenant ${n?"actif":"inactif"}`),await $()}catch{p(),await _("Erreur","Impossible de modifier le statut")}}},Q=async e=>{const n=e.nomComplet||`${e.prenom||""} ${e.nom||""}`.trim()||"ce client";if((await A("Supprimer ?",`Supprimer ${n} dÃ©finitivement ?`,{confirmButtonText:"Oui, supprimer",confirmButtonColor:"#d33"})).isConfirmed){w("Suppression...");try{await C.deleteClient(e.idClient),p(),await f("SupprimÃ© !",`${n} a Ã©tÃ© supprimÃ©`),await $()}catch{p(),await _("Erreur","Impossible de supprimer ce client")}}};return se(()=>{$()}),(e,n)=>(z(),ne("div",Je,[t("div",Qe,[t("div",He,[c(le,{title:"Gestion des Clients",subtitle:k.value,data:y.value,columns:l,actions:U,"show-search":!0,"search-fields":["nomComplet","telephone","email","nomSite"],loading:b.value,"items-per-page":10,"loading-text":"Chargement des clients...","empty-text":"Aucun client trouvÃ© pour votre sociÃ©tÃ©"},{actions:V(()=>[c(ee,{color:"success",size:"sm",onClick:N},{default:V(()=>[We,R(" Nouveau Client ")]),_:1})]),"cell-nomComplet":V(({value:i})=>[t("div",null,[t("h6",Xe,ie(i),1)])]),_:1},8,["subtitle","data","loading"])])]),c(Re,{client:I.value,"modal-id":"clientModal",onSave:a,ref_key:"clientModalRef",ref:h},null,8,["client"])]))}},st=P(Ye,[["__scopeId","data-v-6cf049ae"]]);export{st as default};
