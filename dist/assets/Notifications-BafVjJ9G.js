import{a as h,c as E,q as me,y as fe,l as r,o as a,h as t,m as x,C as v,p as _,f as Y,g as w,t as u,F as pe,D as ve,n as k,u as ge,I as be}from"./vendor-5ChSB122.js";import{_ as ye,c as he,u as _e,f as C,d as L,e as xe}from"./index-C7KYosbF.js";import{A as F}from"./ArgonSelect-BIJzuYL2.js";import{M as we}from"./bootstrap-DXdCWnwj.js";import"./charts-D32nV7-X.js";const ke={class:"container-fluid px-4 py-3"},Ce={class:"row"},Le={class:"col-12 mb-3"},Te={class:"d-flex align-items-center"},Ne={class:"ms-auto d-flex gap-2"},Me={key:0,class:"row mb-3"},Ie={class:"col-md-3"},Se={class:"col-md-3"},Ve={class:"col-md-3"},Ae={class:"col-md-3 d-flex align-items-end"},$e={class:"row mb-4"},qe={class:"col-md-4"},De={class:"card"},Ee={class:"card-body p-3"},Fe={class:"d-flex"},je={class:"ms-3"},ze={class:"font-weight-bolder mb-0"},Be={class:"col-md-4"},Re={class:"card"},He={class:"card-body p-3"},Oe={class:"d-flex"},Ue={class:"ms-3"},Pe={class:"font-weight-bolder mb-0"},Ge={class:"col-md-4"},Je={class:"card"},Ke={class:"card-body p-3"},Qe={class:"d-flex"},We={class:"ms-3"},Xe={class:"font-weight-bolder mb-0"},Ye={class:"row"},Ze={class:"col-12"},et={class:"card"},tt={class:"card-body p-0"},st={key:0,class:"text-center py-5"},ot={key:1,class:"text-center py-5"},it={key:2,class:"list-group list-group-flush"},lt=["onClick"],at={class:"d-flex w-100 justify-content-between align-items-start"},nt={class:"flex-grow-1"},rt={class:"d-flex align-items-center mb-2"},ct={key:0,class:"badge badge-sm bg-gradient-info ms-2"},dt=["innerHTML"],ut={class:"text-muted"},mt={class:"d-flex flex-column align-items-end ms-3"},ft=["onClick"],pt={key:1,class:"fas fa-check-circle text-success",title:"Lu"},vt={class:"modal-dialog modal-dialog-centered notification-modal-dialog"},gt={class:"modal-content"},bt={class:"modal-header bg-gradient-primary text-white"},yt={class:"modal-title d-flex align-items-center gap-2"},ht={key:0,class:"modal-body"},_t={class:"row g-3"},xt={class:"col-md-8"},wt=["innerHTML"],kt={class:"col-md-4"},Ct={class:"list-group list-group-flush text-sm"},Lt={class:"list-group-item px-0 d-flex justify-content-between"},Tt={class:"badge bg-light text-dark"},Nt={class:"list-group-item px-0 d-flex justify-content-between"},Mt={class:"list-group-item px-0 d-flex justify-content-between"},It={class:"list-group-item px-0 d-flex justify-content-between"},St={key:0,class:"fas fa-check-circle text-success me-2"},Vt={key:1,class:"fas fa-circle text-info me-2"},At={key:0,class:"list-group-item px-0 d-flex justify-content-between"},$t={class:"modal-footer"},qt={__name:"Notifications",setup(Dt){const Z=ge(),{requireAuth:ee}=he(),S=_e(),{showSuccess:te,showError:V,showLoading:se,close:j}=xe();ee();const A=h(!1),y=h([]),T=h(!1),N=h(null),l=h(null),z=h(null);let b=null;const c=h({type:"",priorite:"",statut:""}),oe=[{value:"",label:"Tous"},{value:"Info",label:"â„¹ï¸ Info"},{value:"Alerte",label:"âš ï¸ Alerte"},{value:"Vente",label:"ðŸ’° Vente"},{value:"Stock",label:"ðŸ“¦ Stock"},{value:"SystÃ¨me",label:"âš™ï¸ SystÃ¨me"}],ie=[{value:"",label:"Toutes"},{value:"Haute",label:"ðŸ”´ Haute"},{value:"Moyenne",label:"ðŸŸ¡ Moyenne"},{value:"Basse",label:"ðŸŸ¢ Basse"}],le=[{value:"",label:"Toutes"},{value:"nonLues",label:"Non lues"},{value:"lues",label:"Lues"}],B=E(()=>{let s=[...y.value];return c.value.type&&(s=s.filter(e=>e.type===c.value.type)),c.value.priorite&&(s=s.filter(e=>e.priorite===c.value.priorite)),c.value.statut==="lues"?s=s.filter(e=>e.isLu):c.value.statut==="nonLues"&&(s=s.filter(e=>!e.isLu)),s.sort((e,i)=>new Date(i.dateCreation)-new Date(e.dateCreation)),s}),R=E(()=>y.value.filter(s=>!s.isLu)),ae=E(()=>y.value.filter(s=>s.isLu)),H=()=>{try{const s=new(window.AudioContext||window.webkitAudioContext),e=s.createOscillator(),i=s.createGain();e.connect(i),i.connect(s.destination),e.type="sine",e.frequency.setValueAtTime(800,s.currentTime),i.gain.setValueAtTime(0,s.currentTime),i.gain.linearRampToValueAtTime(.3,s.currentTime+.05),i.gain.exponentialRampToValueAtTime(.01,s.currentTime+.3),e.start(s.currentTime),e.stop(s.currentTime+.3),e.onended=()=>{s.close()},console.log("ðŸ”” Son de notification jouÃ©")}catch(s){console.warn("âš ï¸ Impossible de jouer le son:",s)}},O=s=>s?s.replace(/\*\*([^*]+)\*\*/g,'<strong class="text-dark">$1</strong>'):"",U=async()=>{A.value=!0;try{const s=S.userId,e=await L.getNotificationsUtilisateur(s,!1);let i=Array.isArray(e)?e:[];if(console.log("ðŸ“‹ Notifications chargÃ©es:",i.length),i.length>0){console.log("ðŸ”„ Enrichissement des notifications...");const d=S.societeId||3;let o=[],m=[];try{o=await L.getClientsParSiteBySociete(d),m=await L.getCommandesBySociete(d),console.log(`ðŸ“‹ ${(o==null?void 0:o.length)||0} clients et ${(m==null?void 0:m.length)||0} commandes chargÃ©s`)}catch(n){console.warn("âš ï¸ Erreur chargement donnÃ©es enrichissement:",n)}const Q={};(Array.isArray(o)?o:[]).forEach(n=>{const p=n.idClient||n.IdClient,g=n.nomComplet||`${n.prenom||""} ${n.nom||""}`.trim()||`Client #${p}`;Q[String(p)]=g});const W={};(Array.isArray(m)?m:[]).forEach(n=>{const p=n.idCommande||n.IdCommande;W[String(p)]=n}),i=i.map(n=>{let p=n.message||"",g=n.titre||"";return p=p.replace(/client\s+(\d+)/gi,(X,D)=>{const M=Q[D];return M?`**${M}**`:X}),p=p.replace(/Commande\s+#(\d+)\s+enregistr[Ã©e]+\s+pour\s+\*\*([^*]+)\*\*/gi,(X,D,M)=>{const I=W[D];return`Vente${I!=null&&I.montantTotal?` de **${parseFloat(I.montantTotal).toLocaleString("fr-CD")} FC**`:""} pour **${M}**`}),g.toLowerCase().includes("vente")?g="ðŸ’° Nouvelle Vente":g.toLowerCase().includes("compte")?g="âœ… Compte ActivÃ©":g.toLowerCase().includes("stock")&&(g="ðŸ“¦ Alerte Stock"),{...n,titre:g,message:p}}),console.log("âœ… Notifications enrichies")}y.value=i;const f=i.filter(d=>!d.isLu).length;if(N.value!==null&&f>N.value){const d=f-N.value;console.log(`ðŸ”” ${d} nouvelle(s) notification(s) dÃ©tectÃ©e(s) !`),H()}N.value=f}catch(s){console.error("âŒ Erreur chargement notifications:",s),await V("Erreur","Impossible de charger les notifications")}finally{A.value=!1}},P=async s=>{try{await L.marquerNotificationLue(s);const e=y.value.find(i=>i.idNotification===s);e&&(e.isLu=!0,e.dateLecture=new Date().toISOString())}catch(e){console.error("âŒ Erreur:",e),await V("Erreur","Impossible de marquer comme lu")}},ne=async()=>{se("Marquage en cours...");try{const s=S.userId;await L.marquerToutLu(s),y.value.forEach(e=>{e.isLu=!0,e.dateLecture=new Date().toISOString()}),j(),await te("TerminÃ© !","Toutes les notifications sont marquÃ©es comme lues")}catch(s){j(),console.error("âŒ Erreur:",s),await V("Erreur","Impossible de marquer tout comme lu")}},re=s=>{l.value=s,s.isLu||P(s.idNotification),b||(b=new we(z.value,{backdrop:"static"})),b.show()},$=()=>{b&&b.hide(),l.value=null},ce=()=>{var s;(s=l.value)!=null&&s.lien&&(Z.push(l.value.lien),$())},G=s=>s?new Date(s).toLocaleString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",J=s=>({Info:"fas fa-info-circle text-info",Alerte:"fas fa-exclamation-triangle text-warning",Vente:"fas fa-cash-register text-success",Stock:"fas fa-box text-primary",SystÃ¨me:"fas fa-cog text-secondary"})[s]||"fas fa-bell text-secondary",K=s=>({Haute:"bg-gradient-danger",Moyenne:"bg-gradient-warning",Basse:"bg-gradient-success"})[s]||"bg-gradient-secondary",de=s=>{if(!s)return"-";const e=new Date(s),f=new Date-e,d=Math.floor(f/6e4),o=Math.floor(f/36e5),m=Math.floor(f/864e5);return d<1?"Ã€ l'instant":d<60?`Il y a ${d} min`:o<24?`Il y a ${o}h`:m<7?`Il y a ${m}j`:e.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})},ue=()=>{c.value={type:"",priorite:"",statut:""}};let q=null;return me(()=>{U(),q=setInterval(()=>{console.log("ðŸ”„ VÃ©rification automatique des nouvelles notifications..."),U()},3e4),console.log("âœ… VÃ©rification automatique des notifications activÃ©e (toutes les 30s)")}),fe(()=>{q&&(clearInterval(q),console.log("ðŸ›‘ VÃ©rification automatique des notifications arrÃªtÃ©e")),b&&(b.hide(),b=null)}),(s,e)=>{var i,f,d;return a(),r("div",ke,[t("div",Ce,[t("div",Le,[t("div",Te,[e[7]||(e[7]=t("div",null,[t("h4",{class:"mb-0"},[t("i",{class:"fas fa-bell me-2 text-info"}),v(" Notifications")]),t("p",{class:"text-sm text-white mb-0"},"GÃ©rez vos notifications")],-1)),t("div",Ne,[_(C,{color:"light",size:"sm",onClick:H,title:"Tester le son de notification"},{default:w(()=>[...e[4]||(e[4]=[t("i",{class:"fas fa-volume-up me-1"},null,-1),v(" Tester le son ",-1)])]),_:1}),R.value.length>0?(a(),Y(C,{key:0,color:"info",size:"sm",onClick:ne},{default:w(()=>[...e[5]||(e[5]=[t("i",{class:"fas fa-check-double me-1"},null,-1),v(" Tout marquer comme lu ",-1)])]),_:1})):x("",!0),_(C,{color:"secondary",size:"sm",onClick:e[0]||(e[0]=o=>T.value=!T.value)},{default:w(()=>[e[6]||(e[6]=t("i",{class:"fas fa-filter me-1"},null,-1)),v(" "+u(T.value?"Masquer":"Filtres"),1)]),_:1})])])])]),T.value?(a(),r("div",Me,[t("div",Ie,[e[8]||(e[8]=t("label",{class:"form-label text-sm"},"Type",-1)),_(F,{modelValue:c.value.type,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value.type=o),options:oe,placeholder:"Tous"},null,8,["modelValue"])]),t("div",Se,[e[9]||(e[9]=t("label",{class:"form-label text-sm"},"PrioritÃ©",-1)),_(F,{modelValue:c.value.priorite,"onUpdate:modelValue":e[2]||(e[2]=o=>c.value.priorite=o),options:ie,placeholder:"Toutes"},null,8,["modelValue"])]),t("div",Ve,[e[10]||(e[10]=t("label",{class:"form-label text-sm"},"Statut",-1)),_(F,{modelValue:c.value.statut,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.statut=o),options:le,placeholder:"Toutes"},null,8,["modelValue"])]),t("div",Ae,[_(C,{color:"secondary",size:"md",class:"w-100",onClick:ue},{default:w(()=>[...e[11]||(e[11]=[t("i",{class:"fas fa-redo me-1"},null,-1),v(" RÃ©initialiser ",-1)])]),_:1})])])):x("",!0),t("div",$e,[t("div",qe,[t("div",De,[t("div",Ee,[t("div",Fe,[e[13]||(e[13]=t("div",{class:"icon icon-shape bg-gradient-primary shadow text-center border-radius-md"},[t("i",{class:"ni ni-bell-55 text-lg opacity-10"})],-1)),t("div",je,[e[12]||(e[12]=t("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Total",-1)),t("h5",ze,u(y.value.length),1)])])])])]),t("div",Be,[t("div",Re,[t("div",He,[t("div",Oe,[e[15]||(e[15]=t("div",{class:"icon icon-shape bg-gradient-info shadow text-center border-radius-md"},[t("i",{class:"ni ni-email-83 text-lg opacity-10"})],-1)),t("div",Ue,[e[14]||(e[14]=t("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Non lues",-1)),t("h5",Pe,u(R.value.length),1)])])])])]),t("div",Ge,[t("div",Je,[t("div",Ke,[t("div",Qe,[e[17]||(e[17]=t("div",{class:"icon icon-shape bg-gradient-success shadow text-center border-radius-md"},[t("i",{class:"ni ni-check-bold text-lg opacity-10"})],-1)),t("div",We,[e[16]||(e[16]=t("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Lues",-1)),t("h5",Xe,u(ae.value.length),1)])])])])])]),t("div",Ye,[t("div",Ze,[t("div",et,[t("div",tt,[A.value?(a(),r("div",st,[...e[18]||(e[18]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Chargement...")],-1)])])):B.value.length===0?(a(),r("div",ot,[...e[19]||(e[19]=[t("i",{class:"fas fa-bell-slash fa-3x text-secondary mb-3"},null,-1),t("p",{class:"text-secondary mb-0"},"Aucune notification",-1)])])):(a(),r("div",it,[(a(!0),r(pe,null,ve(B.value,o=>(a(),r("div",{key:o.idNotification,class:k(["list-group-item list-group-item-action",{"bg-light":!o.isLu}]),onClick:m=>re(o),style:{cursor:"pointer"}},[t("div",at,[t("div",nt,[t("div",rt,[t("i",{class:k([J(o.type),"me-2"])},null,2),t("h6",{class:k(["mb-0 me-2",{"font-weight-bold":!o.isLu}])},u(o.titre),3),t("span",{class:k(["badge badge-sm",K(o.priorite)])},u(o.priorite),3),o.isLu?x("",!0):(a(),r("span",ct," Nouveau "))]),t("p",{class:"text-sm text-secondary mb-1",innerHTML:O(o.message)},null,8,dt),t("small",ut,[e[20]||(e[20]=t("i",{class:"far fa-clock me-1"},null,-1)),v(" "+u(de(o.dateCreation)),1)])]),t("div",mt,[o.isLu?(a(),r("i",pt)):(a(),r("button",{key:0,onClick:be(m=>P(o.idNotification),["stop"]),class:"btn btn-sm btn-link text-info p-0 mb-2",title:"Marquer comme lu"},[...e[21]||(e[21]=[t("i",{class:"fas fa-check"},null,-1)])],8,ft))])])],10,lt))),128))]))])])])]),t("div",{class:"modal fade",id:"notificationModal",tabindex:"-1",ref_key:"notificationModalRef",ref:z},[t("div",vt,[t("div",gt,[t("div",bt,[t("h5",yt,[t("i",{class:k(J(((i=l.value)==null?void 0:i.type)||""))},null,2),v(" "+u(((f=l.value)==null?void 0:f.titre)||"Notification"),1)]),t("button",{type:"button",class:"btn-close btn-close-white",onClick:$})]),l.value?(a(),r("div",ht,[t("div",_t,[t("div",xt,[e[22]||(e[22]=t("p",{class:"text-sm text-muted mb-1"},"Message",-1)),t("div",{class:"alert alert-secondary",innerHTML:O(l.value.message)},null,8,wt)]),t("div",kt,[e[28]||(e[28]=t("p",{class:"text-sm text-muted mb-1"},"Informations",-1)),t("ul",Ct,[t("li",Lt,[e[23]||(e[23]=t("span",null,"Type",-1)),t("span",Tt,u(l.value.type||"â€”"),1)]),t("li",Nt,[e[24]||(e[24]=t("span",null,"PrioritÃ©",-1)),t("span",{class:k(["badge badge-sm",K(l.value.priorite)])},u(l.value.priorite||"â€”"),3)]),t("li",Mt,[e[25]||(e[25]=t("span",null,"ReÃ§ue",-1)),t("span",null,u(G(l.value.dateCreation)),1)]),t("li",It,[e[26]||(e[26]=t("span",null,"Statut",-1)),t("span",null,[l.value.isLu?(a(),r("i",St)):(a(),r("i",Vt)),v(" "+u(l.value.isLu?"Lue":"Non lue"),1)])]),l.value.dateLecture?(a(),r("li",At,[e[27]||(e[27]=t("span",null,"Lu le",-1)),t("span",null,u(G(l.value.dateLecture)),1)])):x("",!0)])])])])):x("",!0),t("div",$t,[(d=l.value)!=null&&d.lien?(a(),Y(C,{key:0,color:"info",variant:"gradient",onClick:ce},{default:w(()=>[...e[29]||(e[29]=[t("i",{class:"fas fa-external-link-alt me-2"},null,-1),v(" Ouvrir la page liÃ©e ",-1)])]),_:1})):x("",!0),_(C,{color:"secondary",variant:"outline",onClick:$},{default:w(()=>[...e[30]||(e[30]=[v(" Fermer ",-1)])]),_:1})])])])],512)])}}},Ht=ye(qt,[["__scopeId","data-v-d75cb2de"]]);export{Ht as default};
