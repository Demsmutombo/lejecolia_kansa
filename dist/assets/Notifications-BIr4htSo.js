import{a as y,c as j,q as fe,y as he,l as r,o as n,h as e,m as w,p as x,f as ee,g as k,t as m,F as pe,G as ve,C as p,n as C,D as ge,E as be,u as ye,K as xe}from"./vendor-Bjq3GXyS.js";import{_ as we,c as ke,u as Ce,f as L,d as T,e as Le}from"./index-CwjmzDsC.js";import{A as z}from"./ArgonSelect-Do4WPwre.js";import{M as Te}from"./bootstrap-DXdCWnwj.js";import"./charts-D32nV7-X.js";const i=N=>(ge("data-v-d75cb2de"),N=N(),be(),N),Ne={class:"container-fluid px-4 py-3"},Se={class:"row"},Ie={class:"col-12 mb-3"},Me={class:"d-flex align-items-center"},Ve=i(()=>e("div",null,[e("h4",{class:"mb-0"},[e("i",{class:"fas fa-bell me-2 text-info"}),p(" Notifications")]),e("p",{class:"text-sm text-white mb-0"},"GÃ©rez vos notifications")],-1)),Ae={class:"ms-auto d-flex gap-2"},$e=i(()=>e("i",{class:"fas fa-volume-up me-1"},null,-1)),qe=i(()=>e("i",{class:"fas fa-check-double me-1"},null,-1)),De=i(()=>e("i",{class:"fas fa-filter me-1"},null,-1)),Ee={key:0,class:"row mb-3"},Fe={class:"col-md-3"},je=i(()=>e("label",{class:"form-label text-sm"},"Type",-1)),ze={class:"col-md-3"},Be=i(()=>e("label",{class:"form-label text-sm"},"PrioritÃ©",-1)),Re={class:"col-md-3"},He=i(()=>e("label",{class:"form-label text-sm"},"Statut",-1)),Oe={class:"col-md-3 d-flex align-items-end"},Ue=i(()=>e("i",{class:"fas fa-redo me-1"},null,-1)),Pe={class:"row mb-4"},Ge={class:"col-md-4"},Ke={class:"card"},Je={class:"card-body p-3"},Qe={class:"d-flex"},We=i(()=>e("div",{class:"icon icon-shape bg-gradient-primary shadow text-center border-radius-md"},[e("i",{class:"ni ni-bell-55 text-lg opacity-10"})],-1)),Xe={class:"ms-3"},Ye=i(()=>e("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Total",-1)),Ze={class:"font-weight-bolder mb-0"},et={class:"col-md-4"},tt={class:"card"},st={class:"card-body p-3"},ot={class:"d-flex"},it=i(()=>e("div",{class:"icon icon-shape bg-gradient-info shadow text-center border-radius-md"},[e("i",{class:"ni ni-email-83 text-lg opacity-10"})],-1)),at={class:"ms-3"},lt=i(()=>e("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Non lues",-1)),nt={class:"font-weight-bolder mb-0"},ct={class:"col-md-4"},rt={class:"card"},dt={class:"card-body p-3"},ut={class:"d-flex"},mt=i(()=>e("div",{class:"icon icon-shape bg-gradient-success shadow text-center border-radius-md"},[e("i",{class:"ni ni-check-bold text-lg opacity-10"})],-1)),_t={class:"ms-3"},ft=i(()=>e("p",{class:"text-sm mb-0 text-capitalize font-weight-bold"},"Lues",-1)),ht={class:"font-weight-bolder mb-0"},pt={class:"row"},vt={class:"col-12"},gt={class:"card"},bt={class:"card-body p-0"},yt={key:0,class:"text-center py-5"},xt=i(()=>e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Chargement...")],-1)),wt=[xt],kt={key:1,class:"text-center py-5"},Ct=i(()=>e("i",{class:"fas fa-bell-slash fa-3x text-secondary mb-3"},null,-1)),Lt=i(()=>e("p",{class:"text-secondary mb-0"},"Aucune notification",-1)),Tt=[Ct,Lt],Nt={key:2,class:"list-group list-group-flush"},St=["onClick"],It={class:"d-flex w-100 justify-content-between align-items-start"},Mt={class:"flex-grow-1"},Vt={class:"d-flex align-items-center mb-2"},At={key:0,class:"badge badge-sm bg-gradient-info ms-2"},$t=["innerHTML"],qt={class:"text-muted"},Dt=i(()=>e("i",{class:"far fa-clock me-1"},null,-1)),Et={class:"d-flex flex-column align-items-end ms-3"},Ft=["onClick"],jt=i(()=>e("i",{class:"fas fa-check"},null,-1)),zt=[jt],Bt={key:1,class:"fas fa-check-circle text-success",title:"Lu"},Rt={class:"modal-dialog modal-dialog-centered notification-modal-dialog"},Ht={class:"modal-content"},Ot={class:"modal-header bg-gradient-primary text-white"},Ut={class:"modal-title d-flex align-items-center gap-2"},Pt={key:0,class:"modal-body"},Gt={class:"row g-3"},Kt={class:"col-md-8"},Jt=i(()=>e("p",{class:"text-sm text-muted mb-1"},"Message",-1)),Qt=["innerHTML"],Wt={class:"col-md-4"},Xt=i(()=>e("p",{class:"text-sm text-muted mb-1"},"Informations",-1)),Yt={class:"list-group list-group-flush text-sm"},Zt={class:"list-group-item px-0 d-flex justify-content-between"},es=i(()=>e("span",null,"Type",-1)),ts={class:"badge bg-light text-dark"},ss={class:"list-group-item px-0 d-flex justify-content-between"},os=i(()=>e("span",null,"PrioritÃ©",-1)),is={class:"list-group-item px-0 d-flex justify-content-between"},as=i(()=>e("span",null,"ReÃ§ue",-1)),ls={class:"list-group-item px-0 d-flex justify-content-between"},ns=i(()=>e("span",null,"Statut",-1)),cs={key:0,class:"fas fa-check-circle text-success me-2"},rs={key:1,class:"fas fa-circle text-info me-2"},ds={key:0,class:"list-group-item px-0 d-flex justify-content-between"},us=i(()=>e("span",null,"Lu le",-1)),ms={class:"modal-footer"},_s=i(()=>e("i",{class:"fas fa-external-link-alt me-2"},null,-1)),fs={__name:"Notifications",setup(N){const te=ye(),{requireAuth:se}=ke(),A=Ce(),{showSuccess:oe,showError:$,showLoading:ie,close:B}=Le();se();const q=y(!1),b=y([]),S=y(!1),I=y(null),l=y(null),R=y(null);let g=null;const d=y({type:"",priorite:"",statut:""}),ae=[{value:"",label:"Tous"},{value:"Info",label:"â„¹ï¸ Info"},{value:"Alerte",label:"âš ï¸ Alerte"},{value:"Vente",label:"ðŸ’° Vente"},{value:"Stock",label:"ðŸ“¦ Stock"},{value:"SystÃ¨me",label:"âš™ï¸ SystÃ¨me"}],le=[{value:"",label:"Toutes"},{value:"Haute",label:"ðŸ”´ Haute"},{value:"Moyenne",label:"ðŸŸ¡ Moyenne"},{value:"Basse",label:"ðŸŸ¢ Basse"}],ne=[{value:"",label:"Toutes"},{value:"nonLues",label:"Non lues"},{value:"lues",label:"Lues"}],H=j(()=>{let t=[...b.value];return d.value.type&&(t=t.filter(s=>s.type===d.value.type)),d.value.priorite&&(t=t.filter(s=>s.priorite===d.value.priorite)),d.value.statut==="lues"?t=t.filter(s=>s.isLu):d.value.statut==="nonLues"&&(t=t.filter(s=>!s.isLu)),t.sort((s,a)=>new Date(a.dateCreation)-new Date(s.dateCreation)),t}),O=j(()=>b.value.filter(t=>!t.isLu)),ce=j(()=>b.value.filter(t=>t.isLu)),U=()=>{try{const t=new(window.AudioContext||window.webkitAudioContext),s=t.createOscillator(),a=t.createGain();s.connect(a),a.connect(t.destination),s.type="sine",s.frequency.setValueAtTime(800,t.currentTime),a.gain.setValueAtTime(0,t.currentTime),a.gain.linearRampToValueAtTime(.3,t.currentTime+.05),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),s.start(t.currentTime),s.stop(t.currentTime+.3),s.onended=()=>{t.close()},console.log("ðŸ”” Son de notification jouÃ©")}catch(t){console.warn("âš ï¸ Impossible de jouer le son:",t)}},P=t=>t?t.replace(/\*\*([^*]+)\*\*/g,'<strong class="text-dark">$1</strong>'):"",G=async()=>{q.value=!0;try{const t=A.userId,s=await T.getNotificationsUtilisateur(t,!1);let a=Array.isArray(s)?s:[];if(console.log("ðŸ“‹ Notifications chargÃ©es:",a.length),a.length>0){console.log("ðŸ”„ Enrichissement des notifications...");const u=A.societeId||3;let o=[],_=[];try{o=await T.getClientsParSiteBySociete(u),_=await T.getCommandesBySociete(u),console.log(`ðŸ“‹ ${(o==null?void 0:o.length)||0} clients et ${(_==null?void 0:_.length)||0} commandes chargÃ©s`)}catch(c){console.warn("âš ï¸ Erreur chargement donnÃ©es enrichissement:",c)}const X={};(Array.isArray(o)?o:[]).forEach(c=>{const h=c.idClient||c.IdClient,v=c.nomComplet||`${c.prenom||""} ${c.nom||""}`.trim()||`Client #${h}`;X[String(h)]=v});const Y={};(Array.isArray(_)?_:[]).forEach(c=>{const h=c.idCommande||c.IdCommande;Y[String(h)]=c}),a=a.map(c=>{let h=c.message||"",v=c.titre||"";return h=h.replace(/client\s+(\d+)/gi,(Z,F)=>{const M=X[F];return M?`**${M}**`:Z}),h=h.replace(/Commande\s+#(\d+)\s+enregistr[Ã©e]+\s+pour\s+\*\*([^*]+)\*\*/gi,(Z,F,M)=>{const V=Y[F];return`Vente${V!=null&&V.montantTotal?` de **${parseFloat(V.montantTotal).toLocaleString("fr-CD")} FC**`:""} pour **${M}**`}),v.toLowerCase().includes("vente")?v="ðŸ’° Nouvelle Vente":v.toLowerCase().includes("compte")?v="âœ… Compte ActivÃ©":v.toLowerCase().includes("stock")&&(v="ðŸ“¦ Alerte Stock"),{...c,titre:v,message:h}}),console.log("âœ… Notifications enrichies")}b.value=a;const f=a.filter(u=>!u.isLu).length;if(I.value!==null&&f>I.value){const u=f-I.value;console.log(`ðŸ”” ${u} nouvelle(s) notification(s) dÃ©tectÃ©e(s) !`),U()}I.value=f}catch(t){console.error("âŒ Erreur chargement notifications:",t),await $("Erreur","Impossible de charger les notifications")}finally{q.value=!1}},K=async t=>{try{await T.marquerNotificationLue(t);const s=b.value.find(a=>a.idNotification===t);s&&(s.isLu=!0,s.dateLecture=new Date().toISOString())}catch(s){console.error("âŒ Erreur:",s),await $("Erreur","Impossible de marquer comme lu")}},re=async()=>{ie("Marquage en cours...");try{const t=A.userId;await T.marquerToutLu(t),b.value.forEach(s=>{s.isLu=!0,s.dateLecture=new Date().toISOString()}),B(),await oe("TerminÃ© !","Toutes les notifications sont marquÃ©es comme lues")}catch(t){B(),console.error("âŒ Erreur:",t),await $("Erreur","Impossible de marquer tout comme lu")}},de=t=>{l.value=t,t.isLu||K(t.idNotification),g||(g=new Te(R.value,{backdrop:"static"})),g.show()},D=()=>{g&&g.hide(),l.value=null},ue=()=>{var t;(t=l.value)!=null&&t.lien&&(te.push(l.value.lien),D())},J=t=>t?new Date(t).toLocaleString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",Q=t=>({Info:"fas fa-info-circle text-info",Alerte:"fas fa-exclamation-triangle text-warning",Vente:"fas fa-cash-register text-success",Stock:"fas fa-box text-primary",SystÃ¨me:"fas fa-cog text-secondary"})[t]||"fas fa-bell text-secondary",W=t=>({Haute:"bg-gradient-danger",Moyenne:"bg-gradient-warning",Basse:"bg-gradient-success"})[t]||"bg-gradient-secondary",me=t=>{if(!t)return"-";const s=new Date(t),f=new Date-s,u=Math.floor(f/6e4),o=Math.floor(f/36e5),_=Math.floor(f/864e5);return u<1?"Ã€ l'instant":u<60?`Il y a ${u} min`:o<24?`Il y a ${o}h`:_<7?`Il y a ${_}j`:s.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})},_e=()=>{d.value={type:"",priorite:"",statut:""}};let E=null;return fe(()=>{G(),E=setInterval(()=>{console.log("ðŸ”„ VÃ©rification automatique des nouvelles notifications..."),G()},3e4),console.log("âœ… VÃ©rification automatique des notifications activÃ©e (toutes les 30s)")}),he(()=>{E&&(clearInterval(E),console.log("ðŸ›‘ VÃ©rification automatique des notifications arrÃªtÃ©e")),g&&(g.hide(),g=null)}),(t,s)=>{var a,f,u;return n(),r("div",Ne,[e("div",Se,[e("div",Ie,[e("div",Me,[Ve,e("div",Ae,[x(L,{color:"light",size:"sm",onClick:U,title:"Tester le son de notification"},{default:k(()=>[$e,p(" Tester le son ")]),_:1}),O.value.length>0?(n(),ee(L,{key:0,color:"info",size:"sm",onClick:re},{default:k(()=>[qe,p(" Tout marquer comme lu ")]),_:1})):w("",!0),x(L,{color:"secondary",size:"sm",onClick:s[0]||(s[0]=o=>S.value=!S.value)},{default:k(()=>[De,p(" "+m(S.value?"Masquer":"Filtres"),1)]),_:1})])])])]),S.value?(n(),r("div",Ee,[e("div",Fe,[je,x(z,{modelValue:d.value.type,"onUpdate:modelValue":s[1]||(s[1]=o=>d.value.type=o),options:ae,placeholder:"Tous"},null,8,["modelValue"])]),e("div",ze,[Be,x(z,{modelValue:d.value.priorite,"onUpdate:modelValue":s[2]||(s[2]=o=>d.value.priorite=o),options:le,placeholder:"Toutes"},null,8,["modelValue"])]),e("div",Re,[He,x(z,{modelValue:d.value.statut,"onUpdate:modelValue":s[3]||(s[3]=o=>d.value.statut=o),options:ne,placeholder:"Toutes"},null,8,["modelValue"])]),e("div",Oe,[x(L,{color:"secondary",size:"md",class:"w-100",onClick:_e},{default:k(()=>[Ue,p(" RÃ©initialiser ")]),_:1})])])):w("",!0),e("div",Pe,[e("div",Ge,[e("div",Ke,[e("div",Je,[e("div",Qe,[We,e("div",Xe,[Ye,e("h5",Ze,m(b.value.length),1)])])])])]),e("div",et,[e("div",tt,[e("div",st,[e("div",ot,[it,e("div",at,[lt,e("h5",nt,m(O.value.length),1)])])])])]),e("div",ct,[e("div",rt,[e("div",dt,[e("div",ut,[mt,e("div",_t,[ft,e("h5",ht,m(ce.value.length),1)])])])])])]),e("div",pt,[e("div",vt,[e("div",gt,[e("div",bt,[q.value?(n(),r("div",yt,wt)):H.value.length===0?(n(),r("div",kt,Tt)):(n(),r("div",Nt,[(n(!0),r(pe,null,ve(H.value,o=>(n(),r("div",{key:o.idNotification,class:C(["list-group-item list-group-item-action",{"bg-light":!o.isLu}]),onClick:_=>de(o),style:{cursor:"pointer"}},[e("div",It,[e("div",Mt,[e("div",Vt,[e("i",{class:C([Q(o.type),"me-2"])},null,2),e("h6",{class:C(["mb-0 me-2",{"font-weight-bold":!o.isLu}])},m(o.titre),3),e("span",{class:C(["badge badge-sm",W(o.priorite)])},m(o.priorite),3),o.isLu?w("",!0):(n(),r("span",At," Nouveau "))]),e("p",{class:"text-sm text-secondary mb-1",innerHTML:P(o.message)},null,8,$t),e("small",qt,[Dt,p(" "+m(me(o.dateCreation)),1)])]),e("div",Et,[o.isLu?(n(),r("i",Bt)):(n(),r("button",{key:0,onClick:xe(_=>K(o.idNotification),["stop"]),class:"btn btn-sm btn-link text-info p-0 mb-2",title:"Marquer comme lu"},zt,8,Ft))])])],10,St))),128))]))])])])]),e("div",{class:"modal fade",id:"notificationModal",tabindex:"-1",ref_key:"notificationModalRef",ref:R},[e("div",Rt,[e("div",Ht,[e("div",Ot,[e("h5",Ut,[e("i",{class:C(Q(((a=l.value)==null?void 0:a.type)||""))},null,2),p(" "+m(((f=l.value)==null?void 0:f.titre)||"Notification"),1)]),e("button",{type:"button",class:"btn-close btn-close-white",onClick:D})]),l.value?(n(),r("div",Pt,[e("div",Gt,[e("div",Kt,[Jt,e("div",{class:"alert alert-secondary",innerHTML:P(l.value.message)},null,8,Qt)]),e("div",Wt,[Xt,e("ul",Yt,[e("li",Zt,[es,e("span",ts,m(l.value.type||"â€”"),1)]),e("li",ss,[os,e("span",{class:C(["badge badge-sm",W(l.value.priorite)])},m(l.value.priorite||"â€”"),3)]),e("li",is,[as,e("span",null,m(J(l.value.dateCreation)),1)]),e("li",ls,[ns,e("span",null,[l.value.isLu?(n(),r("i",cs)):(n(),r("i",rs)),p(" "+m(l.value.isLu?"Lue":"Non lue"),1)])]),l.value.dateLecture?(n(),r("li",ds,[us,e("span",null,m(J(l.value.dateLecture)),1)])):w("",!0)])])])])):w("",!0),e("div",ms,[(u=l.value)!=null&&u.lien?(n(),ee(L,{key:0,color:"info",variant:"gradient",onClick:ue},{default:k(()=>[_s,p(" Ouvrir la page liÃ©e ")]),_:1})):w("",!0),x(L,{color:"secondary",variant:"outline",onClick:D},{default:k(()=>[p(" Fermer ")]),_:1})])])])],512)])}}},xs=we(fs,[["__scopeId","data-v-d75cb2de"]]);export{xs as default};
