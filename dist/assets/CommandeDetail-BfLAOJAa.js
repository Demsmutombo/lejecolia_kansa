import{a as u,k as M,c as w,q as R,l as i,o as c,m as S,h as t,p as _,C as m,t as n,g as h,b as B,n as k,F as q,D as P}from"./vendor-5ChSB122.js";import{_ as z,c as O,u as W,d as p,e as j,f as N}from"./index-C7KYosbF.js";import"./bootstrap-DXdCWnwj.js";import"./charts-D32nV7-X.js";const H={class:"container-fluid py-4"},Q={key:0,class:"row"},G={key:1,class:"row"},J={class:"col-12"},K={class:"alert alert-danger"},X={key:2,class:"row"},Y={class:"col-12 mb-4"},Z={class:"card"},tt={class:"card-body"},et={class:"d-flex justify-content-between align-items-start"},st={class:"mb-1"},at={class:"text-sm text-secondary mb-2"},ot={class:"text-sm mb-0"},lt={class:"col-lg-4 mb-4"},nt={class:"card h-100"},rt={class:"card-body"},it={class:"info-group"},ct={class:"info-value"},dt={class:"info-group"},ut={class:"info-value"},mt={class:"info-group"},pt={class:"info-value"},vt={class:"info-group"},_t={class:"info-value"},ht={class:"col-lg-8 mb-4"},xt={class:"card h-100"},ft={class:"card-body"},gt={key:0,class:"text-center py-3"},yt={key:1,class:"text-center py-3"},bt={key:2,class:"table-responsive"},Ct={class:"table align-items-center mb-0"},At={class:"text-sm font-weight-bold mb-0"},wt={class:"text-center"},kt={class:"badge bg-gradient-info"},Nt={class:"text-end"},Ut={class:"text-sm mb-0"},Ft={class:"text-center"},Lt={class:"text-xs text-secondary mb-0"},$t={class:"text-center"},Dt={class:"text-xs text-secondary mb-0"},Et={class:"text-end"},Vt={class:"text-sm font-weight-bold mb-0"},Tt={class:"bg-light"},It={class:"text-end"},Mt={class:"text-success"},Rt={__name:"CommandeDetail",setup(St){const U=M(),{requireAuth:F}=O();W();const{showError:L}=j();F();const y=u(U.params.id),o=u(null),d=u([]),x=u(!1),f=u(!1),v=u(null),b=w(()=>{var r;const s=(r=o.value)==null?void 0:r.statut;return{"En cours":"badge bg-gradient-warning",Validée:"badge bg-gradient-info",Livrée:"badge bg-gradient-success",Annulée:"badge bg-gradient-danger"}[s]||"badge bg-gradient-secondary"}),C=s=>{const e=parseFloat(s.quantite)*parseFloat(s.prixUnitaire),r=e*(parseFloat(s.remise)/100),l=(e-r)*(parseFloat(s.tva)/100);return e-r+l},$=w(()=>d.value.reduce((s,e)=>s+C(e),0)),A=s=>{if(!s)return"-";try{return new Date(s).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return s}},g=s=>new Intl.NumberFormat("fr-CD",{style:"currency",currency:"CDF"}).format(parseFloat(s)||0),D=async()=>{x.value=!0,v.value=null;try{const s=await p.getCommandeById(y.value);o.value=s,await E(),await V()}catch{v.value="Commande introuvable",await L("Erreur","Commande introuvable")}finally{x.value=!1}},E=async()=>{try{const[s,e]=await Promise.all([p.getClients(),p.getUsers()]),r={},l={};(Array.isArray(s)?s:[]).forEach(a=>{r[a.idClient]=`${a.prenom} ${a.nom}`}),(Array.isArray(e)?e:[]).forEach(a=>{const I=`${a.nomUtilisateur||""} ${a.postNomUtilisateur||""} ${a.prenomUtilisateur||""}`.trim();l[a.idUtilisateur]=I||`Utilisateur #${a.idUtilisateur}`}),o.value&&(o.value.clientNom=r[o.value.idClient]||`Client #${o.value.idClient}`,o.value.utilisateurNom=l[o.value.idUtilisateur]||`Vendeur #${o.value.idUtilisateur}`)}catch(s){console.warn("Impossible charger noms:",s)}},V=async()=>{f.value=!0;try{const s=await p.searchLignesCommande(y.value,null);d.value=Array.isArray(s)?s:[],console.log("✅ Lignes chargées:",d.value.length),await T()}catch(s){console.error("❌ Erreur chargement lignes:",s),d.value=[]}finally{f.value=!1}},T=async()=>{try{const[s,e]=await Promise.all([p.getStocks(),p.getArticles()]),r={},l={};(Array.isArray(e)?e:[]).forEach(a=>{l[a.idArticle]=a.libelle||`Article #${a.idArticle}`}),(Array.isArray(s)?s:[]).forEach(a=>{r[a.idStock]=l[a.idArticle]||`Article #${a.idArticle}`}),d.value=d.value.map(a=>({...a,articleNom:r[a.idStock]||"Article inconnu"})),console.log("✅ Lignes enrichies avec noms articles")}catch(s){console.warn("⚠️ Impossible charger articles:",s)}};return R(()=>{D()}),(s,e)=>{const r=B("router-link");return c(),i("div",H,[x.value?(c(),i("div",Q,[...e[0]||(e[0]=[t("div",{class:"col-12 text-center py-5"},[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Chargement...")]),t("p",{class:"mt-3"},"Chargement...")],-1)])])):v.value?(c(),i("div",G,[t("div",J,[t("div",K,[e[1]||(e[1]=t("strong",null,"Erreur :",-1)),m(" "+n(v.value),1)]),_(r,{to:"/commandes"},{default:h(()=>[_(N,{color:"secondary"},{default:h(()=>[...e[2]||(e[2]=[t("i",{class:"fas fa-arrow-left me-2"},null,-1),m(" Retour ",-1)])]),_:1})]),_:1})])])):o.value?(c(),i("div",X,[t("div",Y,[t("div",Z,[t("div",tt,[t("div",et,[t("div",null,[t("h3",st,"Commande #"+n(o.value.idCommande),1),t("p",at,[t("span",{class:k(b.value)},n(o.value.statut),3)]),t("p",ot,[e[3]||(e[3]=t("i",{class:"fas fa-calendar me-2"},null,-1)),m(" "+n(A(o.value.dateCommande)),1)])]),t("div",null,[_(r,{to:"/commandes"},{default:h(()=>[_(N,{color:"secondary",size:"sm"},{default:h(()=>[...e[4]||(e[4]=[t("i",{class:"fas fa-arrow-left me-2"},null,-1),m(" Retour ",-1)])]),_:1})]),_:1})])])])])]),t("div",lt,[t("div",nt,[e[9]||(e[9]=t("div",{class:"card-header pb-0"},[t("h6",null,[t("i",{class:"fas fa-info-circle me-2 text-primary"}),m("Informations")])],-1)),t("div",rt,[t("div",it,[e[5]||(e[5]=t("label",{class:"info-label"},"Client",-1)),t("p",ct,n(o.value.clientNom||`Client #${o.value.idClient}`),1)]),t("div",dt,[e[6]||(e[6]=t("label",{class:"info-label"},"Vendeur",-1)),t("p",ut,n(o.value.utilisateurNom||`Vendeur #${o.value.idUtilisateur}`),1)]),t("div",mt,[e[7]||(e[7]=t("label",{class:"info-label"},"Date",-1)),t("p",pt,n(A(o.value.dateCommande)),1)]),t("div",vt,[e[8]||(e[8]=t("label",{class:"info-label"},"Statut",-1)),t("p",_t,[t("span",{class:k(b.value)},n(o.value.statut),3)])])])])]),t("div",ht,[t("div",xt,[e[14]||(e[14]=t("div",{class:"card-header pb-0"},[t("h6",null,[t("i",{class:"fas fa-shopping-cart me-2 text-success"}),m("Articles Commandés")])],-1)),t("div",ft,[f.value?(c(),i("div",gt,[...e[10]||(e[10]=[t("div",{class:"spinner-border spinner-border-sm",role:"status"},null,-1),t("p",{class:"text-sm mt-2"},"Chargement des articles...",-1)])])):d.value.length===0?(c(),i("div",yt,[...e[11]||(e[11]=[t("p",{class:"text-secondary"},"Aucun article dans cette commande",-1)])])):(c(),i("div",bt,[t("table",Ct,[e[13]||(e[13]=t("thead",null,[t("tr",null,[t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"},"Article"),t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center"},"Qté"),t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end"},"P.U."),t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center"},"TVA"),t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-center"},"Remise"),t("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 text-end"},"Total")])],-1)),t("tbody",null,[(c(!0),i(q,null,P(d.value,l=>(c(),i("tr",{key:l.idLigneCommande},[t("td",null,[t("p",At,n(l.articleNom||"Article"),1)]),t("td",wt,[t("span",kt,n(parseFloat(l.quantite)),1)]),t("td",Nt,[t("p",Ut,n(g(l.prixUnitaire)),1)]),t("td",Ft,[t("p",Lt,n(parseFloat(l.tva))+"%",1)]),t("td",$t,[t("p",Dt,n(parseFloat(l.remise))+"%",1)]),t("td",Et,[t("p",Vt,n(g(C(l))),1)])]))),128))]),t("tfoot",null,[t("tr",Tt,[e[12]||(e[12]=t("td",{colspan:"5",class:"text-end"},[t("strong",null,"TOTAL COMMANDE:")],-1)),t("td",It,[t("strong",Mt,n(g($.value)),1)])])])])]))])])])])):S("",!0)])}}},Ot=z(Rt,[["__scopeId","data-v-11e03538"]]);export{Ot as default};
