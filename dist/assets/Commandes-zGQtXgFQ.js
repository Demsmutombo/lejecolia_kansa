import{a as f,c as B,w as D,f as P,o as O,g as N,h as i,K as j,p as w,v as z,Q as K,D as R,E as T,q as Q,l as W,u as H,C as J}from"./vendor-Bjq3GXyS.js";import{M as x}from"./bootstrap-DXdCWnwj.js";import{_ as q,u as F,d as C,c as X,e as Y,f as Z}from"./index-CwjmzDsC.js";import{G as ee,D as ae}from"./GenericModal-DhdU3Gn5.js";import{A as V}from"./ArgonSelect-Do4WPwre.js";import"./charts-D32nV7-X.js";const L=m=>(R("data-v-847c47a6"),m=m(),T(),m),te={class:"modal-body-scrollable"},oe={class:"row"},se={class:"col-12 mb-3"},ne=L(()=>i("label",{class:"form-label"},"Client *",-1)),le={class:"row"},ie={class:"col-md-6 mb-3"},de=L(()=>i("label",{class:"form-label"},"Date de Commande *",-1)),re={class:"col-md-6 mb-3"},me=L(()=>i("label",{class:"form-label"},"Statut *",-1)),ce={__name:"CommandeModal",props:{commande:{type:Object,default:null},modalId:{type:String,default:"commandeModal"}},emits:["save","close"],setup(m,{expose:$,emit:A}){const v=F(),S=m,b=A,p=f(null),h=f(!1),d=f([]),g=f(!1),l=B(()=>v.societeId),y=B(()=>S.commande!==null),M=[{value:"En cours",label:"En cours"},{value:"Valid√©e",label:"Valid√©e"},{value:"Livr√©e",label:"Livr√©e"},{value:"Annul√©e",label:"Annul√©e"}],s=f({idCommande:0,idClient:"",idUtilisateur:0,dateCommande:"",statut:"En cours"}),U=(a={})=>{const o=a.nomComplet||`${a.prenomClient||a.prenom||""} ${a.nomClient||a.nom||""}`.trim(),e=a.telephone||a.numeroTelephone||a.contact||"",t=a.nomSite||a.siteName||"";let r=o||`Client #${a.idClient}`;return t&&(r+=` ‚Äì ${t}`),e&&(r+=` (${e})`),r},_=async()=>{if(!l.value){d.value=[];return}g.value=!0;try{const a=await C.getClientsParSiteBySociete(l.value);console.log(`üìã ${Array.isArray(a)?a.length:0} client(s) filtr√©s pour la soci√©t√© #${l.value}`);const o=(Array.isArray(a)?a:[]).map(e=>({value:parseInt(e.idClient,10),label:U(e),raw:e}));d.value=o,console.log("‚úÖ Clients charg√©s pour dropdown:",d.value.length),!s.value.idClient&&d.value.length&&(s.value.idClient=d.value[0].value)}catch(a){console.error("‚ùå Erreur chargement clients:",a),d.value=[]}finally{g.value=!1}};D(()=>S.commande,a=>{if(a){let o="";if(a.dateCommande)try{o=new Date(a.dateCommande).toISOString().slice(0,16)}catch{o=""}s.value={idCommande:a.idCommande||0,idClient:a.idClient?parseInt(a.idClient,10):"",idUtilisateur:a.idUtilisateur||v.userId||0,dateCommande:o,statut:a.statut||"En cours"}}else I()},{immediate:!1});const I=()=>{const o=new Date().toISOString().slice(0,16);s.value={idCommande:0,idClient:d.value.length?d.value[0].value:"",idUtilisateur:v.userId||0,dateCommande:o,statut:"En cours"}},k=()=>s.value.idClient?s.value.dateCommande?s.value.statut?{valid:!0}:{valid:!1,message:"Le statut est obligatoire"}:{valid:!1,message:"La date de commande est obligatoire"}:{valid:!1,message:"Le client est obligatoire"},E=async()=>{const a=k();if(!a.valid){alert(a.message);return}h.value=!0;try{s.value.idUtilisateur||(s.value.idUtilisateur=v.userId),b("save",s.value)}catch(o){console.error("Erreur lors de la sauvegarde:",o)}finally{h.value=!1}};return D(l,()=>{_()},{immediate:!0}),$({resetForm:I,show:()=>{var a;return(a=p.value)==null?void 0:a.show()},hide:()=>{var a;return(a=p.value)==null?void 0:a.hide()},close:()=>{var a;return(a=p.value)==null?void 0:a.hide()}}),(a,o)=>(O(),P(ee,{"modal-id":m.modalId,title:`${y.value?"Modifier":"Nouvelle"} Commande`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":h.value,"loading-text":"Enregistrement...",onConfirm:E,ref_key:"modalRef",ref:p},{body:N(()=>[i("div",te,[i("form",{onSubmit:j(E,["prevent"])},[i("div",oe,[i("div",se,[ne,w(V,{modelValue:s.value.idClient,"onUpdate:modelValue":o[0]||(o[0]=e=>s.value.idClient=e),options:d.value,placeholder:"S√©lectionner un client",disabled:g.value,id:"idClient",name:"idClient","value-key":"value","label-key":"label"},null,8,["modelValue","options","disabled"])])]),i("div",le,[i("div",ie,[de,z(i("input",{"onUpdate:modelValue":o[1]||(o[1]=e=>s.value.dateCommande=e),type:"datetime-local",class:"form-control",id:"dateCommande",name:"dateCommande",required:""},null,512),[[K,s.value.dateCommande]])]),i("div",re,[me,w(V,{modelValue:s.value.statut,"onUpdate:modelValue":o[2]||(o[2]=e=>s.value.statut=e),options:M,placeholder:"S√©lectionner",id:"statut",name:"statut"},null,8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},ue=q(ce,[["__scopeId","data-v-847c47a6"]]),ve=m=>(R("data-v-01fd7996"),m=m(),T(),m),fe={class:"container-fluid py-4"},pe={class:"row"},Ce={class:"col-12"},ge=ve(()=>i("i",{class:"fas fa-plus me-2"},null,-1)),he={__name:"Commandes",setup(m){const $=H(),{requireAuth:A}=X(),v=F(),{showConfirm:S,showSuccess:b,showError:p,showLoading:h,close:d}=Y();A();const g=f(!1),l=f([]),y=f(null),M=f(null),s=[{key:"idCommande",label:"N¬∞",type:"index",align:"center"},{key:"clientNom",label:"Client",render:(e,t)=>e||`Client #${t.idClient}`},{key:"utilisateurNom",label:"Vendeur",render:(e,t)=>e||`User #${t.idUtilisateur}`},{key:"dateCommande",label:"Date",render:e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}},{key:"statut",label:"Statut",align:"center",render:e=>({"En cours":'<span class="badge badge-sm bg-gradient-warning">En cours</span>',Valid√©e:'<span class="badge badge-sm bg-gradient-info">Valid√©e</span>',Livr√©e:'<span class="badge badge-sm bg-gradient-success">Livr√©e</span>',Annul√©e:'<span class="badge badge-sm bg-gradient-danger">Annul√©e</span>'})[e]||`<span class="badge badge-sm bg-gradient-secondary">${e}</span>`}],U=[{name:"view",label:"Voir D√©tails",icon:"fas fa-eye",class:"text-dark",onClick:e=>$.push(`/commandes/${e.idCommande}`)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:e=>E(e)},{name:"delete",label:"Supprimer",icon:"fas fa-ban",class:"text-warning",iconOnly:!0,onClick:e=>o(e)}],_=async()=>{g.value=!0,console.log("üì° Chargement commandes pour soci√©t√©:",v.societeId);try{const e=v.societeId||3,t=await C.getCommandesBySociete(e);Array.isArray(t)?l.value=t:t!=null&&t.data?l.value=t.data:l.value=[],console.log("‚úÖ Commandes charg√©es:",l.value.length),await I()}catch(e){console.error("‚ùå Erreur chargement commandes:",e),await p("Erreur","Impossible de charger les commandes"),l.value=[]}finally{g.value=!1}},I=async()=>{try{const e=v.societeId||3,[t,r]=await Promise.all([C.getClientsParSiteBySociete(e),C.getUtilisateursVueBySociete(e)]),c={},u={};(Array.isArray(t)?t:[]).forEach(n=>{c[n.idClient]=`${n.prenom||""} ${n.nom||""}`.trim()}),(Array.isArray(r)?r:[]).forEach(n=>{const G=`${n.nomUtilisateur||""} ${n.postNomUtilisateur||""} ${n.prenomUtilisateur||""}`.trim();u[n.idUtilisateur]=G||`Utilisateur #${n.idUtilisateur}`}),l.value=l.value.map(n=>({...n,clientNom:c[n.idClient]||`Client #${n.idClient}`,utilisateurNom:u[n.idUtilisateur]||`Vendeur #${n.idUtilisateur}`})),console.log("‚úÖ Noms enrichis:",l.value.length,"commandes")}catch(e){console.warn("‚ö†Ô∏è Impossible de charger les noms:",e)}},k=()=>{y.value=null,new x(document.getElementById("commandeModal")).show()},E=e=>{y.value={...e},new x(document.getElementById("commandeModal")).show()},a=async e=>{var t,r;h("Enregistrement...");try{const c={...e,idSociete:v.societeId||3};e.idCommande&&e.idCommande>0?(await C.updateCommande(e.idCommande,c),await b("Modifi√© !","Commande modifi√©e")):(await C.createCommande(c),await b("Cr√©√© !","Commande cr√©√©e"));const u=x.getInstance(document.getElementById("commandeModal"));u&&u.hide(),await _()}catch(c){d(),console.error("‚ùå Erreur:",c),await p("Erreur",((r=(t=c.response)==null?void 0:t.data)==null?void 0:r.message)||"Erreur de sauvegarde")}},o=async e=>{var r,c;if((await S("Annuler cette commande ?",`La commande #${e.idCommande} sera marqu√©e comme "Annul√©e" (pas supprim√©e d√©finitivement)`,{confirmButtonText:"Oui, annuler",confirmButtonColor:"#d33"})).isConfirmed){h("Annulation...");try{console.log("‚ùå Annulation commande #",e.idCommande);const u=await C.getCommandeById(e.idCommande);await C.updateCommande(e.idCommande,{...u,idSociete:v.societeId||3,statutCommande:"Annul√©e",dateLastModification:new Date().toISOString()}),d(),await b("Annul√©e !","La commande a √©t√© marqu√©e comme annul√©e"),await _()}catch(u){d(),console.error("‚ùå Erreur annulation:",u),await p("Erreur",((c=(r=u.response)==null?void 0:r.data)==null?void 0:c.message)||u.message||"Impossible d'annuler la commande")}}};return Q(()=>{_()}),(e,t)=>(O(),W("div",fe,[i("div",pe,[i("div",Ce,[w(ae,{title:"Gestion des Commandes",subtitle:"Commandes Lejecolia",data:l.value,columns:s,actions:U,"show-search":!0,"search-fields":["clientNom","utilisateurNom","statut"],loading:g.value,"items-per-page":10,"loading-text":"Chargement des commandes...","empty-text":"Aucune commande trouv√©e"},{actions:N(()=>[w(Z,{color:"success",size:"sm",onClick:k},{default:N(()=>[ge,J(" Nouvelle Commande ")]),_:1})]),_:1},8,["data","loading"])])]),w(ue,{commande:y.value,"modal-id":"commandeModal",onSave:a,ref_key:"commandeModalRef",ref:M},null,8,["commande"])]))}},Ee=q(he,[["__scopeId","data-v-01fd7996"]]);export{Ee as default};
