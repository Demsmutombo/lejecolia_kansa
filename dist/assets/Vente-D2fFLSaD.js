import{a as y,w as Fe,c as be,l as c,m as _,o as u,h as e,C as g,t as i,B as H,F as J,D as Ne,q as Ue,A as De,p as S,f as Te,g as O,u as qe,v as pe,O as xe}from"./vendor-5ChSB122.js";import{_ as Ee,u as Ie,d as P,c as Re,f as z,a as L,e as Me}from"./index-C7KYosbF.js";import{A as G}from"./ArgonSelect-BIJzuYL2.js";import"./bootstrap-DXdCWnwj.js";import"./charts-D32nV7-X.js";const Le={key:0,class:"modal fade show d-block",tabindex:"-1",style:{"background-color":"rgba(0,0,0,0.5)"}},je={class:"modal-dialog modal-dialog-centered",style:{"max-width":"700px"}},Be={class:"modal-content"},He={class:"modal-header bg-gradient-primary"},Oe={class:"modal-body p-3",id:"facture-content"},ze={class:"row mb-3"},Ge={class:"col-7"},Je={class:"mb-1"},Qe={class:"mb-1 text-sm"},Ye={key:0,class:"mb-1 text-sm text-muted"},Ke={key:1,class:"mb-0 text-sm text-muted"},We={key:2,class:"mb-0 text-xs text-muted mt-2"},Xe={class:"col-5 text-end"},Ze=["src"],et={key:1,class:"bg-light rounded p-2 mb-1",style:{height:"60px",display:"flex","align-items":"center","justify-content":"center"}},tt={class:"mb-0 text-xs"},st={class:"mb-0 text-xs"},lt={class:"row mb-2"},ot={class:"col-6"},nt={class:"text-xxs"},at={key:0,class:"mb-1"},it={class:"text-muted"},rt={key:1,class:"mb-1"},dt={class:"text-muted"},ut={key:2,class:"mb-0"},ct={class:"text-muted"},mt={key:3,class:"mb-0 mt-2"},vt={class:"col-6"},pt={class:"text-xxs"},xt={class:"mb-0"},bt={class:"text-muted"},ft={class:"row mb-2"},gt={class:"col-12"},ht={class:"mb-0 text-sm"},yt={key:0,class:"mb-0 text-xs text-muted"},wt={key:0},St={key:1,class:"ms-2"},_t={class:"table-responsive"},$t={class:"table table-bordered table-sm"},Vt={class:"text-xs"},Ct={class:"text-xs text-center"},At={class:"text-xs text-end"},kt={class:"text-xs text-end"},Tt={class:"text-xs text-end"},Nt={class:"text-xs text-end font-weight-bold"},Et={class:"row mt-3"},It={class:"col-md-6 offset-md-6"},Pt={class:"card bg-gradient-light"},Ft={class:"card-body p-2"},Ut={class:"d-flex justify-content-between mb-1"},Dt={class:"text-xs font-weight-bold"},qt={class:"d-flex justify-content-between mb-1"},Rt={class:"text-xs font-weight-bold text-danger"},Mt={class:"d-flex justify-content-between mb-1"},Lt={class:"text-xs font-weight-bold"},jt={class:"d-flex justify-content-between"},Bt={class:"text-sm font-weight-bold text-primary"},Ht={class:"row mt-3"},Ot={class:"col-12"},zt={class:"card bg-light"},Gt={class:"card-body p-2"},Jt={class:"row"},Qt={class:"col-6"},Yt={class:"text-sm mb-0 ms-4"},Kt={class:"badge bg-gradient-info"},Wt={class:"col-6"},Xt={class:"text-sm mb-0 ms-4 font-weight-bold"},Zt={class:"row mt-3"},es={class:"col-12 text-center"},ts={class:"text-xs mb-1"},ss={key:0,class:"text-xxs text-muted mb-0"},ls={key:0,class:"ms-2"},os={class:"modal-footer no-print"},ns={__name:"FactureModal",props:{show:Boolean,vente:Object,client:Object},emits:["close"],setup(w,{emit:ve}){const R=w,A=ve,$=Ie(),r=y(null),d=y(null),Q=async()=>{var v,s,b;try{if(!$.societeId){console.log("âš ï¸ Pas de societeId dans userStore");return}console.log("ðŸ”„ Chargement infos sociÃ©tÃ©/site pour facture..."),console.log("ðŸ¢ SocieteId:",$.societeId),console.log("ðŸ“ SiteId:",$.siteId),r.value=await P.getSocieteById($.societeId||3),console.log("âœ… SociÃ©tÃ© trouvÃ©e:",((v=r.value)==null?void 0:v.nomSociete)||"Non trouvÃ©e");const x=await P.getSitesBySociete($.societeId||3),f=Array.isArray(x)?x:(x==null?void 0:x.data)||[];$.siteId?(d.value=f.find(V=>String(V.idSite)===String($.siteId)),console.log("âœ… Site utilisateur:",((s=d.value)==null?void 0:s.nomSite)||"Non trouvÃ©")):(d.value=f[0]||null,console.log("âœ… Premier site de la sociÃ©tÃ©:",((b=d.value)==null?void 0:b.nomSite)||"Aucun site trouvÃ©"))}catch(x){console.error("âŒ Erreur chargement infos sociÃ©tÃ©:",x)}};Fe(()=>R.show,v=>{v&&Q()});const Y=v=>v?new Date(v).toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}):new Date().toLocaleDateString("fr-FR"),k=v=>new Intl.NumberFormat("fr-CD",{style:"currency",currency:"CDF",minimumFractionDigits:0}).format(v||0),j=v=>{const s=v.prixUnitaire*v.quantite,b=s*(v.remise||0)/100,x=s-b,f=x*(v.tva||0)/100;return x+f},F=be(()=>{var f;if(!((f=R.vente)!=null&&f.lignesCommandes))return{sousTotal:0,totalTVA:0,totalRemises:0,total:0};let v=0,s=0,b=0;R.vente.lignesCommandes.forEach(V=>{const E=V.prixUnitaire*V.quantite,T=E*(V.remise||0)/100,n=(E-T)*(V.tva||0)/100;v+=E,b+=T,s+=n});const x=v-b+s;return{sousTotal:v,totalTVA:s,totalRemises:b,total:x}}),M=()=>{var x;const v=document.getElementById("facture-content"),s=document.body.innerHTML,b=v.innerHTML;document.body.innerHTML=`
    <html>
      <head>
        <title>Facture ${((x=R.vente)==null?void 0:x.idVente)||"N/A"}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          .table th { background-color: #f8f9fa; }
          .text-end { text-align: right; }
          .text-center { text-align: center; }
          .text-primary { color: #1565c0; }
          .text-muted { color: #6c757d; }
          .font-weight-bold { font-weight: bold; }
          hr { border: 1px solid #ddd; margin: 15px 0; }
        </style>
      </head>
      <body>${b}</body>
    </html>
  `,window.print(),document.body.innerHTML=s,window.location.reload()},U=()=>{M()};return(v,s)=>{var b,x,f,V,E,T,B,n,h,q,N,K,W,X,Z,ee,te,se,le,oe,ne,C,ae,ie,re,de,ue,o,t,l,a,m,p,I,ce,me,fe,ge,he,ye,we,Se,_e,$e,Ve,Ce,Ae,ke;return w.show?(u(),c("div",Le,[e("div",je,[e("div",Be,[e("div",He,[s[2]||(s[2]=e("h5",{class:"modal-title text-white"},[e("i",{class:"fas fa-file-invoice me-2"}),g(" Facture ")],-1)),e("button",{type:"button",class:"btn-close btn-close-white",onClick:s[0]||(s[0]=D=>A("close"))})]),e("div",Oe,[e("div",ze,[e("div",Ge,[s[7]||(s[7]=e("h4",{class:"text-primary mb-2"},"FACTURE",-1)),e("p",Je,[e("strong",null,i(((b=r.value)==null?void 0:b.nomSociete)||H($).societeName),1)]),e("p",Qe,[s[3]||(s[3]=e("i",{class:"fas fa-store me-2 text-primary"},null,-1)),e("strong",null,i(((x=d.value)==null?void 0:x.nomSite)||H($).siteName),1)]),(f=d.value)!=null&&f.telephone||(V=r.value)!=null&&V.telephone?(u(),c("p",Ye,[s[4]||(s[4]=e("i",{class:"fas fa-phone me-2"},null,-1)),g(i(((E=d.value)==null?void 0:E.telephone)||((T=r.value)==null?void 0:T.telephone)),1)])):_("",!0),(B=d.value)!=null&&B.email||(n=r.value)!=null&&n.email?(u(),c("p",Ke,[s[5]||(s[5]=e("i",{class:"fas fa-envelope me-2"},null,-1)),g(i(((h=d.value)==null?void 0:h.email)||((q=r.value)==null?void 0:q.email)),1)])):_("",!0),(N=d.value)!=null&&N.ville||(K=d.value)!=null&&K.commune?(u(),c("p",We,[s[6]||(s[6]=e("i",{class:"fas fa-map-marker-alt me-2"},null,-1)),g(" "+i([(W=d.value)==null?void 0:W.avenue,(X=d.value)==null?void 0:X.quartier,(Z=d.value)==null?void 0:Z.commune,(ee=d.value)==null?void 0:ee.ville,(te=d.value)==null?void 0:te.province].filter(Boolean).join(", ")),1)])):_("",!0)]),e("div",Xe,[(se=r.value)!=null&&se.logo?(u(),c("img",{key:0,src:r.value.logo,alt:"Logo sociÃ©tÃ©",style:{"max-height":"60px","max-width":"100%","object-fit":"contain","margin-bottom":"0.5rem"}},null,8,Ze)):(u(),c("div",et,[...s[8]||(s[8]=[e("i",{class:"fas fa-building fa-lg text-muted"},null,-1)])])),e("p",tt,[s[9]||(s[9]=e("strong",null,"Date :",-1)),g(" "+i(Y((le=w.vente)==null?void 0:le.dateCreation)),1)]),e("p",st,[s[10]||(s[10]=e("strong",null,"NÂ° :",-1)),g(" "+i(((oe=w.vente)==null?void 0:oe.idVente)||"N/A"),1)])])]),s[33]||(s[33]=e("hr",{class:"horizontal dark my-2"},null,-1)),e("div",lt,[e("div",ot,[s[18]||(s[18]=e("h6",{class:"text-uppercase text-xxs mb-1 text-muted"},"Identifiants Fiscaux",-1)),e("div",nt,[(ne=r.value)!=null&&ne.numeroImpot?(u(),c("p",at,[s[11]||(s[11]=e("strong",null,"NUMÃ‰RO D'IMPÃ”T",-1)),s[12]||(s[12]=e("br",null,null,-1)),e("span",it,i(r.value.numeroImpot),1)])):_("",!0),(C=r.value)!=null&&C.rccm?(u(),c("p",rt,[s[13]||(s[13]=e("strong",null,"RCCM",-1)),s[14]||(s[14]=e("br",null,null,-1)),e("span",dt,i(r.value.rccm),1)])):_("",!0),(ae=r.value)!=null&&ae.idNational?(u(),c("p",ut,[s[15]||(s[15]=e("strong",null,"ID NATIONAL",-1)),s[16]||(s[16]=e("br",null,null,-1)),e("span",ct,i(r.value.idNational),1)])):_("",!0),!((ie=r.value)!=null&&ie.numeroImpot)&&!((re=r.value)!=null&&re.rccm)&&!((de=r.value)!=null&&de.idNational)?(u(),c("p",mt,[...s[17]||(s[17]=[e("span",{class:"text-muted fst-italic"},"Non renseignÃ©s",-1)])])):_("",!0)])]),e("div",vt,[s[21]||(s[21]=e("h6",{class:"text-uppercase text-xxs mb-1 text-muted"},"Adresse",-1)),e("div",pt,[e("p",xt,[s[19]||(s[19]=e("strong",null,"ADRESSE COMPLÃˆTE",-1)),s[20]||(s[20]=e("br",null,null,-1)),e("span",bt,[d.value?(u(),c(J,{key:0},[g(i([d.value.numero?`NÂ° ${d.value.numero}`:"",d.value.avenue?`Avenue ${d.value.avenue}`:"",d.value.quartier,d.value.commune,d.value.ville,d.value.province].filter(Boolean).join(", ")||[(ue=r.value)==null?void 0:ue.avenue,(o=r.value)==null?void 0:o.quartier,(t=r.value)==null?void 0:t.commune,(l=r.value)==null?void 0:l.ville,(a=r.value)==null?void 0:a.province].filter(Boolean).join(", ")||"Non renseignÃ©e"),1)],64)):r.value?(u(),c(J,{key:1},[g(i([r.value.avenue,r.value.quartier,r.value.commune,r.value.ville,r.value.province].filter(Boolean).join(", ")||"Non renseignÃ©e"),1)],64)):(u(),c(J,{key:2},[g(" Non renseignÃ©e ")],64))])])])])]),s[34]||(s[34]=e("hr",{class:"horizontal dark my-2"},null,-1)),e("div",ft,[e("div",gt,[s[22]||(s[22]=e("h6",{class:"text-uppercase text-xxs mb-1 text-muted"},"FacturÃ© Ã  :",-1)),e("p",ht,[e("strong",null,i((m=w.client)==null?void 0:m.nom)+" "+i((p=w.client)==null?void 0:p.prenom),1)]),(I=w.client)!=null&&I.telephone||(ce=w.client)!=null&&ce.email?(u(),c("p",yt,[(me=w.client)!=null&&me.telephone?(u(),c("span",wt,"ðŸ“ž "+i(w.client.telephone),1)):_("",!0),(fe=w.client)!=null&&fe.email?(u(),c("span",St,"ðŸ“§ "+i(w.client.email),1)):_("",!0)])):_("",!0)])]),e("div",_t,[e("table",$t,[s[23]||(s[23]=e("thead",{class:"bg-light"},[e("tr",null,[e("th",{class:"text-uppercase text-xxs font-weight-bolder"},"Article"),e("th",{class:"text-uppercase text-xxs font-weight-bolder text-center"},"QtÃ©"),e("th",{class:"text-uppercase text-xxs font-weight-bolder text-end"},"P.U."),e("th",{class:"text-uppercase text-xxs font-weight-bolder text-end"},"TVA"),e("th",{class:"text-uppercase text-xxs font-weight-bolder text-end"},"Rem."),e("th",{class:"text-uppercase text-xxs font-weight-bolder text-end"},"Total")])],-1)),e("tbody",null,[(u(!0),c(J,null,Ne((ge=w.vente)==null?void 0:ge.lignesCommandes,(D,Pe)=>(u(),c("tr",{key:Pe},[e("td",Vt,i(D.articleNom),1),e("td",Ct,i(D.quantite),1),e("td",At,i(k(D.prixUnitaire)),1),e("td",kt,i(D.tva||0)+"%",1),e("td",Tt,i(D.remise||0)+"%",1),e("td",Nt,i(k(j(D))),1)]))),128))])])]),e("div",Et,[e("div",It,[e("div",Pt,[e("div",Ft,[e("div",Ut,[s[24]||(s[24]=e("span",{class:"text-xs"},"Sous-total HT :",-1)),e("span",Dt,i(k(F.value.sousTotal)),1)]),e("div",qt,[s[25]||(s[25]=e("span",{class:"text-xs"},"Remises :",-1)),e("span",Rt,"- "+i(k(F.value.totalRemises)),1)]),e("div",Mt,[s[26]||(s[26]=e("span",{class:"text-xs"},"TVA :",-1)),e("span",Lt,i(k(F.value.totalTVA)),1)]),s[28]||(s[28]=e("hr",{class:"horizontal dark my-1"},null,-1)),e("div",jt,[s[27]||(s[27]=e("span",{class:"text-sm font-weight-bold"},"TOTAL TTC :",-1)),e("span",Bt,i(k(F.value.total)),1)])])])])]),e("div",Ht,[e("div",Ot,[e("div",zt,[e("div",Gt,[e("div",Jt,[e("div",Qt,[s[29]||(s[29]=e("p",{class:"text-xs mb-0"},[e("i",{class:"fas fa-credit-card me-2 text-info"}),e("strong",null,"Mode de paiement :")],-1)),e("p",Yt,[e("span",Kt,i(((he=w.vente)==null?void 0:he.modePaiement)||"N/A"),1)])]),e("div",Wt,[s[30]||(s[30]=e("p",{class:"text-xs mb-0"},[e("i",{class:"fas fa-user-tie me-2 text-primary"}),e("strong",null,"Vendeur :")],-1)),e("p",Xt,i(H($).userName||H($).nomUtilisateur||"N/A"),1)])])])])])]),e("div",Zt,[e("div",es,[s[31]||(s[31]=e("hr",{class:"horizontal dark my-2"},null,-1)),e("p",ts,[e("strong",null,i(((ye=r.value)==null?void 0:ye.nomSociete)||H($).societeName),1)]),(we=r.value)!=null&&we.telephone||(Se=d.value)!=null&&Se.telephone?(u(),c("p",ss,[g(" ðŸ“ž "+i(((_e=r.value)==null?void 0:_e.telephone)||(($e=d.value)==null?void 0:$e.telephone))+" ",1),(Ve=r.value)!=null&&Ve.email||(Ce=d.value)!=null&&Ce.email?(u(),c("span",ls," ðŸ“§ "+i(((Ae=r.value)==null?void 0:Ae.email)||((ke=d.value)==null?void 0:ke.email)),1)):_("",!0)])):_("",!0),s[32]||(s[32]=e("p",{class:"text-xxs text-muted mt-2 mb-0"},[e("em",null,"Facture gÃ©nÃ©rÃ©e via Lejecolia")],-1))])])]),e("div",os,[e("button",{type:"button",class:"btn btn-secondary",onClick:s[1]||(s[1]=D=>A("close"))},[...s[35]||(s[35]=[e("i",{class:"fas fa-times me-2"},null,-1),g(" Fermer ",-1)])]),e("button",{type:"button",class:"btn btn-info",onClick:M},[...s[36]||(s[36]=[e("i",{class:"fas fa-print me-2"},null,-1),g(" Imprimer ",-1)])]),e("button",{type:"button",class:"btn btn-primary",onClick:U},[...s[37]||(s[37]=[e("i",{class:"fas fa-file-pdf me-2"},null,-1),g(" TÃ©lÃ©charger PDF ",-1)])])])])])])):_("",!0)}}},as=Ee(ns,[["__scopeId","data-v-b0e9f1ab"]]),is={class:"container-fluid px-4 py-3"},rs={class:"row mb-4"},ds={class:"col-xl-3 col-sm-6 mb-xl-0 mb-4"},us={class:"card bg-gradient-success shadow-sm"},cs={class:"card-body p-3 text-white"},ms={class:"d-flex align-items-center"},vs={class:"font-weight-bolder mb-0"},ps={key:0},xs={key:1},bs={class:"text-xs mb-0"},fs={key:0,class:"ms-2"},gs={class:"row"},hs={class:"col-lg-8"},ys={class:"card mb-4"},ws={class:"card-header pb-0"},Ss={class:"d-flex align-items-center"},_s={class:"card-body"},$s={key:0,class:"row"},Vs={class:"col-12 mb-3"},Cs={key:1,class:"row"},As={class:"col-md-6 mb-3"},ks={class:"col-md-6 mb-3"},Ts={class:"col-md-6 mb-3"},Ns={class:"col-md-6 mb-3"},Es={class:"col-md-6 mb-3"},Is={class:"col-md-6 mb-3"},Ps={class:"card"},Fs={class:"card-body"},Us={class:"row mb-4"},Ds={class:"col-md-8"},qs={class:"col-md-2"},Rs={class:"col-md-2 d-flex align-items-end"},Ms={class:"table-responsive"},Ls={class:"table align-items-center mb-0"},js={key:0},Bs={class:"text-sm font-weight-bold mb-0"},Hs={class:"text-xs text-secondary mb-0"},Os={class:"align-middle text-center"},zs=["onUpdate:modelValue","max"],Gs={class:"align-middle text-end"},Js={class:"text-secondary text-sm"},Qs={class:"align-middle text-end"},Ys=["onUpdate:modelValue"],Ks={class:"align-middle text-end"},Ws=["onUpdate:modelValue"],Xs={class:"align-middle text-end"},Zs={class:"text-sm font-weight-bold"},el={class:"align-middle text-center"},tl=["onClick"],sl={class:"col-lg-4"},ll={class:"card mb-4"},ol={class:"card-body"},nl={class:"mb-3"},al={class:"mb-3"},il={class:"card bg-gradient-dark"},rl={class:"card-body p-3"},dl={class:"d-flex justify-content-between mb-2"},ul={class:"text-white font-weight-bold"},cl={class:"d-flex justify-content-between mb-2"},ml={class:"text-white font-weight-bold"},vl={class:"d-flex justify-content-between mb-2"},pl={class:"text-white font-weight-bold"},xl={class:"d-flex justify-content-between"},bl={class:"text-white font-weight-bold h5 mb-0"},fl={class:"mt-4 d-grid gap-2"},gl={__name:"Vente",setup(w){const ve=qe(),{requireAuth:R}=Re(),A=Ie(),{showSuccess:$,showError:r,showLoading:d,close:Q,showConfirm:Y}=Me();R();const k=y(!1),j=y(!1),F=y(!1),M=y(!1),U=y(!1),v=y(!1),s=y([]),b=y([]),x=y([]),f=y([]),V=y(!1),E=y(null),T=y(null),B=[{value:"EspÃ¨ces",label:"ðŸ’µ EspÃ¨ces"},{value:"Carte bancaire",label:"ðŸ’³ Carte bancaire"},{value:"Virement",label:"ðŸ¦ Virement"},{value:"Mobile Money",label:"ðŸ“± Mobile Money"}],n=y({clientExistant:null,nom:"",prenom:"",genre:"",email:"",telephone:"",dateNaissance:null,idSite:0,pieceIdentite:"",province:"",ville:"",commune:"",quartier:"",avenue:"",numero:"",idUtilisateur:A.userId,dateCommande:new Date().toISOString(),statutCommande:"ValidÃ©e",datePaiement:new Date().toISOString(),modePaiement:"",montant:0,referencePaiement:"",statutPaiement:"PayÃ©",libellePaiement:"",catalogueId:0,lignesCommandes:[]}),h=y({idStock:null,quantite:"1"}),q=y({ventes:0,ca:0}),N=be(()=>{let o=0,t=0,l=0;n.value.lignesCommandes.forEach(m=>{const p=m.prixUnitaire*m.quantite,I=p*m.remise/100,me=(p-I)*m.tva/100;o+=p,l+=I,t+=me});const a=o-l+t;return{sousTotal:o,totalTVA:t,totalRemises:l,total:a}}),K=be(()=>{const o=U.value?n.value.nom&&n.value.prenom&&n.value.telephone:n.value.clientExistant,t=n.value.lignesCommandes.length>0,l=n.value.modePaiement;return o&&t&&l}),W=(o={})=>{const t=o.nomComplet||`${o.prenomClient||o.prenom||""} ${o.nomClient||o.nom||""}`.trim(),l=o.telephone||o.numeroTelephone||o.contact||"",a=o.nomSite||o.siteName||o.site||"";let m=t||`Client #${o.idClient}`;return a&&(m+=` â€“ ${a}`),l&&(m+=` (${l})`),m},X=async()=>{j.value=!0;try{const o=A.societeId;if(!o){s.value=[];return}console.log(`ðŸ“‹ Chargement clients pour point de vente (sociÃ©tÃ© #${o})...`);const t=await P.getClientsParSiteBySociete(o),l=Array.isArray(t)?t:[];console.log(`âœ… ${l.length} client(s) disponible(s) pour la vente`),s.value=l.map(a=>({value:parseInt(a.idClient,10),label:W(a),raw:a}))}catch(o){console.error("âŒ Erreur chargement clients:",o),s.value=[]}finally{j.value=!1}},Z=o=>{const t=o.articleNom||o.nomArticle||o.libelle||o.descriptionArticle||`Article #${o.idArticle}`,l=o.siteNom||o.nomSite||o.site||"",a=o.prixVentHT||o.prixVente||o.prix||o.prixUnitaire||0,m=parseFloat(o.quantiteStock)||0;let p=`${t} (Stock: ${m.toFixed(0)})`;return l&&(p+=` â€“ ${l}`),p+=` â€“ ${C(a)}`,p},ee=async()=>{F.value=!0;try{const o=A.societeId;if(!o){x.value=[],b.value=[];return}console.log(`ðŸ“¦ Chargement stocks pour point de vente (sociÃ©tÃ© #${o})...`);const t=await P.getStocksVueBySociete(o);let l=Array.isArray(t)?t:[];l=l.filter(a=>parseFloat(a.quantiteStock)>0&&a.statut!==!1).map(a=>({...a,articleNom:a.articleNom||a.nomArticle||a.libelleArticle||a.libelle||a.descriptionArticle||`Article #${a.idArticle}`,siteNom:a.siteNom||a.nomSite||a.site||"",prixVentHT:a.prixVentHT||a.prixVente||a.prix||a.prixUnitaire||0})),console.log(`âœ… ${l.length} stock(s) disponible(s) pour la vente`),x.value=l,b.value=l.map(a=>({value:a.idStock,label:Z(a),articleNom:a.articleNom,prixVentHT:parseFloat(a.prixVentHT),quantiteStock:parseFloat(a.quantiteStock)})),console.log("âœ… Stocks formatÃ©s pour le dropdown:",b.value.length)}catch(o){console.error("âŒ Erreur chargement stocks:",o),x.value=[],b.value=[]}finally{F.value=!1}},te=async o=>{if(!o)return;const t=s.value.find(a=>a.value===o),l=t==null?void 0:t.raw;l&&(n.value.nom=l.nom||l.nomClient||"",n.value.prenom=l.prenom||l.prenomClient||"",n.value.genre=l.genre||l.sex||"",n.value.email=l.email||"",n.value.telephone=l.telephone||l.numeroTelephone||l.contact||"",l.idSite&&(n.value.idSite=parseInt(l.idSite,10)))},se=o=>{const t=b.value.find(l=>l.value===o);t&&(h.value.prixUnitaire=t.prixVentHT,h.value.articleNom=t.articleNom,h.value.stockDisponible=t.quantiteStock)},le=()=>{if(!h.value.idStock)return;const o=b.value.find(l=>l.value===h.value.idStock);if(!o)return;if(n.value.lignesCommandes.find(l=>l.idStock===h.value.idStock)){r("Erreur","Cet article est dÃ©jÃ  dans le panier");return}if(h.value.quantite>parseFloat(o.quantiteStock)){r("Erreur",`QuantitÃ© insuffisante (disponible: ${parseFloat(o.quantiteStock).toFixed(0)})`);return}n.value.lignesCommandes.push({idStock:h.value.idStock,articleNom:o.articleNom,quantite:parseFloat(h.value.quantite),prixUnitaire:parseFloat(o.prixVentHT),tva:16,remise:0,stockDisponible:parseFloat(o.quantiteStock).toFixed(0)}),h.value={idStock:null,quantite:"1"}},oe=o=>{n.value.lignesCommandes.splice(o,1)},ne=o=>{const t=o.prixUnitaire*o.quantite,l=t*o.remise/100,a=t-l,m=a*o.tva/100;return a+m},C=o=>new Intl.NumberFormat("fr-CD",{style:"currency",currency:"CDF"}).format(o),ae=()=>{n.value.clientExistant=null,n.value.nom="",n.value.prenom="",n.value.genre="",n.value.email="",n.value.telephone="",f.value.length>0&&(n.value.idSite=f.value[0].value)},ie=async()=>{var t,l;if(console.log("ðŸš€ðŸš€ðŸš€ NOUVEAU CODE VENTE.VUE CHARGÃ‰ - VERSION 2.0 ðŸš€ðŸš€ðŸš€"),!!(await Y("Confirmer la vente ?",`Montant total: ${C(N.value.total)}`,{confirmButtonText:"Oui, valider",confirmButtonColor:"#2dce89"})).isConfirmed){d("Enregistrement de la vente...","Veuillez patienter"),k.value=!0;try{n.value.referencePaiement||(n.value.referencePaiement=`PAY-${Date.now()}-${Math.floor(Math.random()*1e3)}`),n.value.montant=N.value.total,n.value.libellePaiement=`Vente ${n.value.modePaiement} - ${n.value.referencePaiement}`;let a=null,m="";console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log("ðŸ’¾ ENREGISTREMENT VENTE - SystÃ¨me SP avec Fallback [v2.0]"),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");try{console.log("ðŸ”„ Tentative 1/3: Stored Procedure (SP)..."),a=await P.enregistrerVenteSP(n.value),m="Stored Procedure (SP)",console.log("âœ… SuccÃ¨s avec Stored Procedure !")}catch(p){console.warn("âš ï¸ SP Ã©chouÃ©e:",p.message);try{console.log("ðŸ”„ Tentative 2/3: MÃ©thode Standard (EF)..."),a=await P.enregistrerVente(n.value),m="MÃ©thode Standard (Entity Framework)",console.log("âœ… SuccÃ¨s avec mÃ©thode standard !")}catch(I){console.warn("âš ï¸ Standard Ã©chouÃ©e:",I.message);try{console.log("ðŸ”„ Tentative 3/3: MÃ©thode Alternative..."),a=await P.enregistrerVenteAlternative(n.value),m="MÃ©thode Alternative",console.log("âœ… SuccÃ¨s avec mÃ©thode alternative !")}catch{throw console.error("âŒ Toutes les mÃ©thodes ont Ã©chouÃ© !"),new Error("Impossible d'enregistrer la vente avec aucune mÃ©thode disponible")}}}if(console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(`âœ… VENTE ENREGISTRÃ‰E via: ${m}`),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),Q(),await $("Vente enregistrÃ©e !",`Montant total : ${C(N.value.total)}`),E.value={...n.value,idVente:(a==null?void 0:a.idVente)||(a==null?void 0:a.id)||Date.now(),dateCreation:new Date().toISOString(),methodeEnregistrement:m},console.log("ðŸ“‹ PrÃ©paration donnÃ©es client pour facture..."),console.log("ðŸ“‹ showClientForm:",U.value),console.log("ðŸ“‹ clientExistant:",n.value.clientExistant),console.log("ðŸ“‹ nom/prenom:",n.value.nom,n.value.prenom),n.value.clientExistant){const p=s.value.find(I=>I.value===n.value.clientExistant);console.log("ðŸ‘¤ Client existant sÃ©lectionnÃ©:",p),T.value={nom:(p==null?void 0:p.nom)||"",prenom:(p==null?void 0:p.prenom)||"",telephone:(p==null?void 0:p.telephone)||"",email:(p==null?void 0:p.email)||""}}else console.log("ðŸ‘¤ Nouveau client crÃ©Ã© avec donnÃ©es formulaire"),T.value={nom:n.value.nom,prenom:n.value.prenom,telephone:n.value.telephone,email:n.value.email};console.log("âœ… DonnÃ©es client pour facture:",T.value),V.value=!0}catch(a){Q(),console.error("âŒ Erreur fatale:",a),await r("Erreur",((l=(t=a.response)==null?void 0:t.data)==null?void 0:l.message)||a.message||"Impossible d'enregistrer la vente")}finally{k.value=!1}}},re=async()=>{(await Y("Annuler ?","Toutes les donnÃ©es seront perdues",{confirmButtonText:"Oui, annuler",confirmButtonColor:"#f5365c"})).isConfirmed&&ve.push("/dashboard")},de=async()=>{M.value=!0;try{const o=A.societeId;if(!o){f.value=[];return}console.log("ðŸ¢ Chargement sites pour nouveau client...");const t=await P.getSitesBySociete(o),l=Array.isArray(t)?t:[];console.log(`âœ… ${l.length} site(s) associÃ©(s) trouvÃ©(s) pour la sociÃ©tÃ© #${o}`),f.value=l.map(a=>({value:parseInt(a.idSite,10),label:a.nomSite||a.nom||`Site #${a.idSite}`})),f.value.length>0&&!n.value.idSite&&(n.value.idSite=f.value[0].value,console.log("âœ… Site prÃ©-sÃ©lectionnÃ©:",f.value[0].label)),console.log("âœ… Sites chargÃ©s pour dropdown:",f.value.length)}catch(o){console.error("âŒ Erreur chargement sites:",o),f.value=[]}finally{M.value=!1}},ue=async()=>{v.value=!0;try{const o=new Date().toISOString().split("T")[0],t=await P.getJournalVenteStatsDate(o,{idSociete:A.isSuperAdmin?void 0:A.societeId,idSite:A.siteId||void 0,idUtilisateur:A.userId||void 0}),l=parseInt((t==null?void 0:t.ventes)??(t==null?void 0:t.nombreVentes)??(t==null?void 0:t.totalVentes)??(t==null?void 0:t.commandes)??(t==null?void 0:t.nombreCommandes)??(t==null?void 0:t.nbVentes)??(t==null?void 0:t.count)??0,10)||0,a=parseFloat((t==null?void 0:t.ca)??(t==null?void 0:t.montant)??(t==null?void 0:t.montantTotal)??(t==null?void 0:t.total)??0)||0;q.value={ventes:l,ca:a}}catch(o){console.error("âŒ Erreur chargement stats ventes du jour:",o),q.value={ventes:0,ca:0}}finally{v.value=!1}};return Ue(()=>{X(),ee(),de(),ue()}),(o,t)=>(u(),c("div",is,[t[48]||(t[48]=De('<div class="row" data-v-a258122f><div class="col-12 mb-3" data-v-a258122f><h4 class="mb-0" data-v-a258122f><i class="fas fa-cash-register me-2 text-success" data-v-a258122f></i> Point de Vente</h4><p class="text-sm text-white mb-0" data-v-a258122f>Enregistrer une nouvelle vente</p></div></div>',1)),e("div",rs,[e("div",ds,[e("div",us,[e("div",cs,[e("div",ms,[t[18]||(t[18]=e("div",{class:"icon icon-shape bg-white text-success shadow text-center border-radius-md me-3"},[e("i",{class:"ni ni-cart text-lg"})],-1)),e("div",null,[t[17]||(t[17]=e("p",{class:"text-sm mb-1 text-uppercase"},"VENTES DU JOUR",-1)),e("h4",vs,[v.value?(u(),c("span",ps,[...t[14]||(t[14]=[e("i",{class:"fas fa-spinner fa-spin me-2"},null,-1),g("Chargement... ",-1)])])):(u(),c("span",xs,i(q.value.ventes),1))]),e("p",bs,[t[15]||(t[15]=e("span",{class:"font-weight-bold"},"Ventes",-1)),t[16]||(t[16]=g(" aujourd'hui ",-1)),v.value?_("",!0):(u(),c("span",fs,"â€¢ "+i(C(q.value.ca)),1))])])])])])])]),e("div",gs,[e("div",hs,[e("div",ys,[e("div",ws,[e("div",Ss,[t[21]||(t[21]=e("h6",{class:"mb-0"},"ðŸ‘¤ Client",-1)),U.value?(u(),Te(z,{key:1,color:"secondary",size:"sm",class:"ms-auto",onClick:t[1]||(t[1]=l=>{U.value=!1,ae()})},{default:O(()=>[...t[20]||(t[20]=[e("i",{class:"fas fa-times me-1"},null,-1),g(" Annuler ",-1)])]),_:1})):(u(),Te(z,{key:0,color:"info",size:"sm",class:"ms-auto",onClick:t[0]||(t[0]=l=>U.value=!0)},{default:O(()=>[...t[19]||(t[19]=[e("i",{class:"fas fa-user-plus me-1"},null,-1),g(" Nouveau Client ",-1)])]),_:1}))])]),e("div",_s,[U.value?(u(),c("div",Cs,[e("div",As,[t[23]||(t[23]=e("label",{class:"form-label"},"Nom *",-1)),S(L,{modelValue:n.value.nom,"onUpdate:modelValue":t[3]||(t[3]=l=>n.value.nom=l),placeholder:"Nom","is-required":!0},null,8,["modelValue"])]),e("div",ks,[t[24]||(t[24]=e("label",{class:"form-label"},"PrÃ©nom *",-1)),S(L,{modelValue:n.value.prenom,"onUpdate:modelValue":t[4]||(t[4]=l=>n.value.prenom=l),placeholder:"PrÃ©nom","is-required":!0},null,8,["modelValue"])]),e("div",Ts,[t[25]||(t[25]=e("label",{class:"form-label"},"TÃ©lÃ©phone *",-1)),S(L,{modelValue:n.value.telephone,"onUpdate:modelValue":t[5]||(t[5]=l=>n.value.telephone=l),placeholder:"+243 123 456 789","is-required":!0},null,8,["modelValue"])]),e("div",Ns,[t[26]||(t[26]=e("label",{class:"form-label"},"Email",-1)),S(L,{modelValue:n.value.email,"onUpdate:modelValue":t[6]||(t[6]=l=>n.value.email=l),type:"email",placeholder:"email@example.com"},null,8,["modelValue"])]),e("div",Es,[t[27]||(t[27]=e("label",{class:"form-label"},"Genre",-1)),S(G,{modelValue:n.value.genre,"onUpdate:modelValue":t[7]||(t[7]=l=>n.value.genre=l),options:[{value:"M",label:"Masculin"},{value:"F",label:"FÃ©minin"}],placeholder:"SÃ©lectionner"},null,8,["modelValue"])]),e("div",Is,[t[28]||(t[28]=e("label",{class:"form-label"},"Site *",-1)),S(G,{modelValue:n.value.idSite,"onUpdate:modelValue":t[8]||(t[8]=l=>n.value.idSite=l),options:f.value,placeholder:"SÃ©lectionner un site",disabled:M.value},null,8,["modelValue","options","disabled"])])])):(u(),c("div",$s,[e("div",Vs,[t[22]||(t[22]=e("label",{class:"form-label"},"SÃ©lectionner un client existant",-1)),S(G,{modelValue:n.value.clientExistant,"onUpdate:modelValue":[t[2]||(t[2]=l=>n.value.clientExistant=l),te],options:s.value,placeholder:"Choisir un client...",disabled:j.value},null,8,["modelValue","options","disabled"])])]))])]),e("div",Ps,[t[37]||(t[37]=e("div",{class:"card-header pb-0"},[e("h6",{class:"mb-0"},"ðŸ›’ Panier")],-1)),e("div",Fs,[e("div",Us,[e("div",Ds,[t[29]||(t[29]=e("label",{class:"form-label"},"Article",-1)),S(G,{modelValue:h.value.idStock,"onUpdate:modelValue":[t[9]||(t[9]=l=>h.value.idStock=l),se],options:b.value,placeholder:"SÃ©lectionner un article...",disabled:F.value},null,8,["modelValue","options","disabled"])]),e("div",qs,[t[30]||(t[30]=e("label",{class:"form-label"},"QtÃ©",-1)),S(L,{modelValue:h.value.quantite,"onUpdate:modelValue":t[10]||(t[10]=l=>h.value.quantite=l),type:"number",step:"1",min:"1",placeholder:"1"},null,8,["modelValue"])]),e("div",Rs,[S(z,{color:"success",size:"md",class:"w-100",onClick:le,disabled:!h.value.idStock},{default:O(()=>[...t[31]||(t[31]=[e("i",{class:"fas fa-plus"},null,-1)])]),_:1},8,["disabled"])])]),e("div",Ms,[e("table",Ls,[t[36]||(t[36]=e("thead",null,[e("tr",null,[e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder"},"Article"),e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder text-center"},"QtÃ©"),e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder text-end"},"P.U."),e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder text-end"},"TVA"),e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder text-end"},"Remise"),e("th",{class:"text-uppercase text-secondary text-xxs font-weight-bolder text-end"},"Total"),e("th")])],-1)),e("tbody",null,[n.value.lignesCommandes.length===0?(u(),c("tr",js,[...t[32]||(t[32]=[e("td",{colspan:"7",class:"text-center text-secondary py-4"},[e("i",{class:"fas fa-shopping-cart fa-2x mb-2"}),e("p",{class:"mb-0"},"Panier vide")],-1)])])):_("",!0),(u(!0),c(J,null,Ne(n.value.lignesCommandes,(l,a)=>(u(),c("tr",{key:a},[e("td",null,[e("p",Bs,i(l.articleNom),1),e("p",Hs,"Stock disponible: "+i(l.stockDisponible),1)]),e("td",Os,[pe(e("input",{"onUpdate:modelValue":m=>l.quantite=m,type:"number",min:"1",max:l.stockDisponible,step:"1",class:"form-control form-control-sm text-center d-inline-block",style:{width:"70px","font-size":"0.875rem"}},null,8,zs),[[xe,l.quantite,void 0,{number:!0}]])]),e("td",Gs,[e("span",Js,i(C(l.prixUnitaire)),1)]),e("td",Qs,[pe(e("input",{"onUpdate:modelValue":m=>l.tva=m,type:"number",min:"0",max:"100",step:"0.1",class:"form-control form-control-sm text-end d-inline-block",style:{width:"60px","font-size":"0.875rem"}},null,8,Ys),[[xe,l.tva,void 0,{number:!0}]]),t[33]||(t[33]=e("span",{class:"text-secondary text-sm ms-1"},"%",-1))]),e("td",Ks,[pe(e("input",{"onUpdate:modelValue":m=>l.remise=m,type:"number",min:"0",max:"100",step:"0.1",class:"form-control form-control-sm text-end d-inline-block",style:{width:"60px","font-size":"0.875rem"}},null,8,Ws),[[xe,l.remise,void 0,{number:!0}]]),t[34]||(t[34]=e("span",{class:"text-secondary text-sm ms-1"},"%",-1))]),e("td",Xs,[e("span",Zs,i(C(ne(l))),1)]),e("td",el,[e("button",{onClick:m=>oe(a),class:"btn btn-link text-danger p-0 mb-0",title:"Retirer"},[...t[35]||(t[35]=[e("i",{class:"fas fa-trash text-sm"},null,-1)])],8,tl)])]))),128))])])])])])]),e("div",sl,[e("div",ll,[t[40]||(t[40]=e("div",{class:"card-header pb-0"},[e("h6",{class:"mb-0"},"ðŸ’³ Paiement")],-1)),e("div",ol,[e("div",nl,[t[38]||(t[38]=e("label",{class:"form-label"},"Mode de Paiement *",-1)),S(G,{modelValue:n.value.modePaiement,"onUpdate:modelValue":t[11]||(t[11]=l=>n.value.modePaiement=l),options:B,placeholder:"SÃ©lectionner"},null,8,["modelValue"])]),e("div",al,[t[39]||(t[39]=e("label",{class:"form-label"},"RÃ©fÃ©rence Paiement",-1)),S(L,{modelValue:n.value.referencePaiement,"onUpdate:modelValue":t[12]||(t[12]=l=>n.value.referencePaiement=l),placeholder:"GÃ©nÃ©rÃ© automatiquement"},null,8,["modelValue"])])])]),e("div",il,[e("div",rl,[e("div",dl,[t[41]||(t[41]=e("span",{class:"text-white text-sm"},"Sous-total:",-1)),e("span",ul,i(C(N.value.sousTotal)),1)]),e("div",cl,[t[42]||(t[42]=e("span",{class:"text-white text-sm"},"TVA:",-1)),e("span",ml,i(C(N.value.totalTVA)),1)]),e("div",vl,[t[43]||(t[43]=e("span",{class:"text-white text-sm"},"Remises:",-1)),e("span",pl,"-"+i(C(N.value.totalRemises)),1)]),t[45]||(t[45]=e("hr",{class:"horizontal light my-3"},null,-1)),e("div",xl,[t[44]||(t[44]=e("span",{class:"text-white font-weight-bold"},"TOTAL:",-1)),e("span",bl,i(C(N.value.total)),1)])])]),e("div",fl,[S(z,{color:"success",size:"lg",onClick:ie,disabled:!K.value||k.value},{default:O(()=>[t[46]||(t[46]=e("i",{class:"fas fa-check-circle me-2"},null,-1)),g(" "+i(k.value?"Traitement...":"Valider la Vente"),1)]),_:1},8,["disabled"]),S(z,{color:"secondary",size:"md",onClick:re},{default:O(()=>[...t[47]||(t[47]=[e("i",{class:"fas fa-times me-2"},null,-1),g(" Annuler ",-1)])]),_:1})])])]),S(as,{show:V.value,vente:E.value,client:T.value,onClose:t[13]||(t[13]=l=>V.value=!1)},null,8,["show","vente","client"])]))}},$l=Ee(gl,[["__scopeId","data-v-a258122f"]]);export{$l as default};
