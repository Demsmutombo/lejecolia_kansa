import{a as v,c as L,w as B,f as q,o as D,g as N,h as i,I as F,p as w,v as G,O as P,q as j,l as z,u as W,C as H}from"./vendor-5ChSB122.js";import{M as x}from"./bootstrap-DXdCWnwj.js";import{_ as O,u as R,d as C,c as J,e as K,f as Q}from"./index-C7KYosbF.js";import{G as X,D as Y}from"./GenericModal-D2OVyllk.js";import{A as V}from"./ArgonSelect-BIJzuYL2.js";import"./charts-D32nV7-X.js";const Z={class:"modal-body-scrollable"},ee={class:"row"},ae={class:"col-12 mb-3"},te={class:"row"},oe={class:"col-md-6 mb-3"},se={class:"col-md-6 mb-3"},ne={__name:"CommandeModal",props:{commande:{type:Object,default:null},modalId:{type:String,default:"commandeModal"}},emits:["save","close"],setup(E,{expose:A,emit:$}){const u=R(),S=E,b=$,f=v(null),p=v(!1),d=v([]),g=v(!1),l=L(()=>u.societeId),y=L(()=>S.commande!==null),M=[{value:"En cours",label:"En cours"},{value:"Valid√©e",label:"Valid√©e"},{value:"Livr√©e",label:"Livr√©e"},{value:"Annul√©e",label:"Annul√©e"}],s=v({idCommande:0,idClient:"",idUtilisateur:0,dateCommande:"",statut:"En cours"}),U=(a={})=>{const o=a.nomComplet||`${a.prenomClient||a.prenom||""} ${a.nomClient||a.nom||""}`.trim(),e=a.telephone||a.numeroTelephone||a.contact||"",t=a.nomSite||a.siteName||"";let r=o||`Client #${a.idClient}`;return t&&(r+=` ‚Äì ${t}`),e&&(r+=` (${e})`),r},h=async()=>{if(!l.value){d.value=[];return}g.value=!0;try{const a=await C.getClientsParSiteBySociete(l.value);console.log(`üìã ${Array.isArray(a)?a.length:0} client(s) filtr√©s pour la soci√©t√© #${l.value}`);const o=(Array.isArray(a)?a:[]).map(e=>({value:parseInt(e.idClient,10),label:U(e),raw:e}));d.value=o,console.log("‚úÖ Clients charg√©s pour dropdown:",d.value.length),!s.value.idClient&&d.value.length&&(s.value.idClient=d.value[0].value)}catch(a){console.error("‚ùå Erreur chargement clients:",a),d.value=[]}finally{g.value=!1}};B(()=>S.commande,a=>{if(a){let o="";if(a.dateCommande)try{o=new Date(a.dateCommande).toISOString().slice(0,16)}catch{o=""}s.value={idCommande:a.idCommande||0,idClient:a.idClient?parseInt(a.idClient,10):"",idUtilisateur:a.idUtilisateur||u.userId||0,dateCommande:o,statut:a.statut||"En cours"}}else I()},{immediate:!1});const I=()=>{const o=new Date().toISOString().slice(0,16);s.value={idCommande:0,idClient:d.value.length?d.value[0].value:"",idUtilisateur:u.userId||0,dateCommande:o,statut:"En cours"}},k=()=>s.value.idClient?s.value.dateCommande?s.value.statut?{valid:!0}:{valid:!1,message:"Le statut est obligatoire"}:{valid:!1,message:"La date de commande est obligatoire"}:{valid:!1,message:"Le client est obligatoire"},_=async()=>{const a=k();if(!a.valid){alert(a.message);return}p.value=!0;try{s.value.idUtilisateur||(s.value.idUtilisateur=u.userId),b("save",s.value)}catch(o){console.error("Erreur lors de la sauvegarde:",o)}finally{p.value=!1}};return B(l,()=>{h()},{immediate:!0}),A({resetForm:I,show:()=>{var a;return(a=f.value)==null?void 0:a.show()},hide:()=>{var a;return(a=f.value)==null?void 0:a.hide()},close:()=>{var a;return(a=f.value)==null?void 0:a.hide()}}),(a,o)=>(D(),q(X,{"modal-id":E.modalId,title:`${y.value?"Modifier":"Nouvelle"} Commande`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":p.value,"loading-text":"Enregistrement...",onConfirm:_,ref_key:"modalRef",ref:f},{body:N(()=>[i("div",Z,[i("form",{onSubmit:F(_,["prevent"])},[i("div",ee,[i("div",ae,[o[3]||(o[3]=i("label",{class:"form-label"},"Client *",-1)),w(V,{modelValue:s.value.idClient,"onUpdate:modelValue":o[0]||(o[0]=e=>s.value.idClient=e),options:d.value,placeholder:"S√©lectionner un client",disabled:g.value,id:"idClient",name:"idClient","value-key":"value","label-key":"label"},null,8,["modelValue","options","disabled"])])]),i("div",te,[i("div",oe,[o[4]||(o[4]=i("label",{class:"form-label"},"Date de Commande *",-1)),G(i("input",{"onUpdate:modelValue":o[1]||(o[1]=e=>s.value.dateCommande=e),type:"datetime-local",class:"form-control",id:"dateCommande",name:"dateCommande",required:""},null,512),[[P,s.value.dateCommande]])]),i("div",se,[o[5]||(o[5]=i("label",{class:"form-label"},"Statut *",-1)),w(V,{modelValue:s.value.statut,"onUpdate:modelValue":o[2]||(o[2]=e=>s.value.statut=e),options:M,placeholder:"S√©lectionner",id:"statut",name:"statut"},null,8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},le=O(ne,[["__scopeId","data-v-847c47a6"]]),ie={class:"container-fluid py-4"},de={class:"row"},re={class:"col-12"},me={__name:"Commandes",setup(E){const A=W(),{requireAuth:$}=J(),u=R(),{showConfirm:S,showSuccess:b,showError:f,showLoading:p,close:d}=K();$();const g=v(!1),l=v([]),y=v(null),M=v(null),s=[{key:"idCommande",label:"N¬∞",type:"index",align:"center"},{key:"clientNom",label:"Client",render:(e,t)=>e||`Client #${t.idClient}`},{key:"utilisateurNom",label:"Vendeur",render:(e,t)=>e||`User #${t.idUtilisateur}`},{key:"dateCommande",label:"Date",render:e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}}},{key:"statut",label:"Statut",align:"center",render:e=>({"En cours":'<span class="badge badge-sm bg-gradient-warning">En cours</span>',Valid√©e:'<span class="badge badge-sm bg-gradient-info">Valid√©e</span>',Livr√©e:'<span class="badge badge-sm bg-gradient-success">Livr√©e</span>',Annul√©e:'<span class="badge badge-sm bg-gradient-danger">Annul√©e</span>'})[e]||`<span class="badge badge-sm bg-gradient-secondary">${e}</span>`}],U=[{name:"view",label:"Voir D√©tails",icon:"fas fa-eye",class:"text-dark",onClick:e=>A.push(`/commandes/${e.idCommande}`)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:e=>_(e)},{name:"delete",label:"Supprimer",icon:"fas fa-ban",class:"text-warning",iconOnly:!0,onClick:e=>o(e)}],h=async()=>{g.value=!0,console.log("üì° Chargement commandes pour soci√©t√©:",u.societeId);try{const e=u.societeId||3,t=await C.getCommandesBySociete(e);Array.isArray(t)?l.value=t:t!=null&&t.data?l.value=t.data:l.value=[],console.log("‚úÖ Commandes charg√©es:",l.value.length),await I()}catch(e){console.error("‚ùå Erreur chargement commandes:",e),await f("Erreur","Impossible de charger les commandes"),l.value=[]}finally{g.value=!1}},I=async()=>{try{const e=u.societeId||3,[t,r]=await Promise.all([C.getClientsParSiteBySociete(e),C.getUtilisateursVueBySociete(e)]),m={},c={};(Array.isArray(t)?t:[]).forEach(n=>{m[n.idClient]=`${n.prenom||""} ${n.nom||""}`.trim()}),(Array.isArray(r)?r:[]).forEach(n=>{const T=`${n.nomUtilisateur||""} ${n.postNomUtilisateur||""} ${n.prenomUtilisateur||""}`.trim();c[n.idUtilisateur]=T||`Utilisateur #${n.idUtilisateur}`}),l.value=l.value.map(n=>({...n,clientNom:m[n.idClient]||`Client #${n.idClient}`,utilisateurNom:c[n.idUtilisateur]||`Vendeur #${n.idUtilisateur}`})),console.log("‚úÖ Noms enrichis:",l.value.length,"commandes")}catch(e){console.warn("‚ö†Ô∏è Impossible de charger les noms:",e)}},k=()=>{y.value=null,new x(document.getElementById("commandeModal")).show()},_=e=>{y.value={...e},new x(document.getElementById("commandeModal")).show()},a=async e=>{var t,r;p("Enregistrement...");try{const m={...e,idSociete:u.societeId||3};e.idCommande&&e.idCommande>0?(await C.updateCommande(e.idCommande,m),await b("Modifi√© !","Commande modifi√©e")):(await C.createCommande(m),await b("Cr√©√© !","Commande cr√©√©e"));const c=x.getInstance(document.getElementById("commandeModal"));c&&c.hide(),await h()}catch(m){d(),console.error("‚ùå Erreur:",m),await f("Erreur",((r=(t=m.response)==null?void 0:t.data)==null?void 0:r.message)||"Erreur de sauvegarde")}},o=async e=>{var r,m;if((await S("Annuler cette commande ?",`La commande #${e.idCommande} sera marqu√©e comme "Annul√©e" (pas supprim√©e d√©finitivement)`,{confirmButtonText:"Oui, annuler",confirmButtonColor:"#d33"})).isConfirmed){p("Annulation...");try{console.log("‚ùå Annulation commande #",e.idCommande);const c=await C.getCommandeById(e.idCommande);await C.updateCommande(e.idCommande,{...c,idSociete:u.societeId||3,statutCommande:"Annul√©e",dateLastModification:new Date().toISOString()}),d(),await b("Annul√©e !","La commande a √©t√© marqu√©e comme annul√©e"),await h()}catch(c){d(),console.error("‚ùå Erreur annulation:",c),await f("Erreur",((m=(r=c.response)==null?void 0:r.data)==null?void 0:m.message)||c.message||"Impossible d'annuler la commande")}}};return j(()=>{h()}),(e,t)=>(D(),z("div",ie,[i("div",de,[i("div",re,[w(Y,{title:"Gestion des Commandes",subtitle:"Commandes Lejecolia",data:l.value,columns:s,actions:U,"show-search":!0,"search-fields":["clientNom","utilisateurNom","statut"],loading:g.value,"items-per-page":10,"loading-text":"Chargement des commandes...","empty-text":"Aucune commande trouv√©e"},{actions:N(()=>[w(Q,{color:"success",size:"sm",onClick:k},{default:N(()=>[...t[0]||(t[0]=[i("i",{class:"fas fa-plus me-2"},null,-1),H(" Nouvelle Commande ",-1)])]),_:1})]),_:1},8,["data","loading"])])]),w(le,{commande:y.value,"modal-id":"commandeModal",onSave:a,ref_key:"commandeModalRef",ref:M},null,8,["commande"])]))}},pe=O(me,[["__scopeId","data-v-01fd7996"]]);export{pe as default};
