import{M as H}from"./bootstrap-DXdCWnwj.js";import{_ as R,u as z,a as I,b as P,d as b,c as G,e as Q,f as j}from"./index-C7KYosbF.js";import{G as W,D as J}from"./GenericModal-D2OVyllk.js";import{a as r,c as L,w as K,q as O,f as X,o as x,g as C,h as o,I as Y,l as _,m as $,p as c,C as B,t as U}from"./vendor-5ChSB122.js";import{A as D}from"./ArgonSelect-BIJzuYL2.js";import"./charts-D32nV7-X.js";const Z={class:"modal-body-scrollable"},ee={class:"row"},te={class:"col-md-6 mb-3"},ae={key:0,class:"text-muted"},se={class:"col-md-6 mb-3"},le={key:0,class:"text-muted"},oe={class:"row"},ie={class:"col-md-6 mb-3"},re={class:"col-md-6 mb-3"},ne={class:"row"},ce={class:"col-md-6 mb-3"},de={class:"col-md-6 mb-3"},ue={key:0,class:"row"},me={class:"col-12 mb-3"},pe={class:"alert alert-info py-2 mb-0"},ve={key:0,class:"text-danger"},fe={class:"row"},ge={class:"col-12 mb-3"},Se={__name:"StockModal",props:{stock:{type:Object,default:null},modalId:{type:String,default:"stockModal"}},emits:["save","close"],setup(M,{expose:T,emit:k}){const h=z(),v=M,y=k,m=r(null),d=r(!1),p=r([]),n=r([]),f=r(!1),w=r(!1),g=L(()=>v.stock!==null),A=L(()=>{const s=parseFloat(l.value.prixAchat)||0,e=parseFloat(l.value.prixVentHT)||0;if(s===0||e===0)return null;const t=e-s,a=t/s*100;return{montant:t,pourcentage:a}}),l=r({idStock:0,idArticle:"",idSite:"",quantiteStock:0,prixAchat:0,prixVentHT:0,seuilAlerte:10,statut:!0}),E=async()=>{f.value=!0;try{const s=h.societeId||3,e=await b.getArticlesBySociete(s);p.value=(Array.isArray(e)?e:[]).map(t=>({value:parseInt(t.idArticle,10),label:t.libelle})),console.log("‚úÖ Articles charg√©s:",p.value.length)}catch(s){console.error("‚ùå Erreur chargement articles:",s),p.value=[]}finally{f.value=!1}},q=async()=>{w.value=!0;try{const s=h.societeId||3,e=await b.getSitesBySociete(s),t=Array.isArray(e)?e:[];n.value=t.map(a=>({value:parseInt(a.idSite,10),label:a.nomSite})),console.log("‚úÖ Sites charg√©s:",n.value.length)}catch(s){console.error("‚ùå Erreur chargement sites:",s),n.value=[]}finally{w.value=!1}};K(()=>v.stock,s=>{s?l.value={idStock:s.idStock||0,idArticle:s.idArticle?parseInt(s.idArticle,10):"",idSite:s.idSite?parseInt(s.idSite,10):"",quantiteStock:s.quantiteStock||0,prixAchat:s.prixAchat||0,prixVentHT:s.prixVentHT||0,seuilAlerte:s.seuilAlerte||10,statut:s.statut!==void 0?s.statut:!0}:N()},{immediate:!1});const N=()=>{l.value={idStock:0,idArticle:"",idSite:"",quantiteStock:0,prixAchat:0,prixVentHT:0,seuilAlerte:10,statut:!0}},F=()=>l.value.idArticle?l.value.idSite?l.value.quantiteStock===""||l.value.quantiteStock===null||l.value.quantiteStock===void 0?{valid:!1,message:"La quantit√© en stock est obligatoire"}:!l.value.prixVentHT||l.value.prixVentHT<=0?{valid:!1,message:"Le prix de vente HT doit √™tre sup√©rieur √† 0"}:{valid:!0}:{valid:!1,message:"Le site est obligatoire"}:{valid:!1,message:"L'article est obligatoire"},V=async()=>{const s=F();if(!s.valid){alert(s.message);return}d.value=!0;try{y("save",l.value)}catch(e){console.error("Erreur lors de la sauvegarde:",e)}finally{d.value=!1}};return O(()=>{E(),q()}),T({resetForm:N,show:()=>{var s;return(s=m.value)==null?void 0:s.show()},hide:()=>{var s;return(s=m.value)==null?void 0:s.hide()},close:()=>{var s;return(s=m.value)==null?void 0:s.hide()}}),(s,e)=>(x(),X(W,{"modal-id":M.modalId,title:`${g.value?"Modifier":"Nouveau"} Stock`,size:"md","confirm-text":"Enregistrer","confirm-icon":"fas fa-save","confirm-color":"success","is-loading":d.value,"loading-text":"Enregistrement...",onConfirm:V,ref_key:"modalRef",ref:m},{body:C(()=>[o("div",Z,[o("form",{onSubmit:Y(V,["prevent"])},[e[16]||(e[16]=o("h6",{class:"text-sm mt-0 mb-2"},"R√©f√©rences",-1)),o("div",ee,[o("div",te,[e[7]||(e[7]=o("label",{class:"form-label"},"Article *",-1)),c(D,{modelValue:l.value.idArticle,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.idArticle=t),options:p.value,placeholder:"S√©lectionner un article",disabled:f.value||g.value,id:"idArticle",name:"idArticle"},null,8,["modelValue","options","disabled"]),g.value?(x(),_("small",ae,"Non modifiable en √©dition")):$("",!0)]),o("div",se,[e[8]||(e[8]=o("label",{class:"form-label"},"Site *",-1)),c(D,{modelValue:l.value.idSite,"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.idSite=t),options:n.value,placeholder:"S√©lectionner un site",disabled:w.value||g.value,id:"idSite",name:"idSite"},null,8,["modelValue","options","disabled"]),g.value?(x(),_("small",le,"Non modifiable en √©dition")):$("",!0)])]),e[17]||(e[17]=o("h6",{class:"text-sm mt-3 mb-2"},"Quantit√©",-1)),o("div",oe,[o("div",ie,[e[9]||(e[9]=o("label",{class:"form-label"},"Quantit√© en Stock *",-1)),c(I,{modelValue:l.value.quantiteStock,"onUpdate:modelValue":e[2]||(e[2]=t=>l.value.quantiteStock=t),type:"number",step:"0.01",placeholder:"0.00","is-required":!0,id:"quantiteStock",name:"quantiteStock"},null,8,["modelValue"])]),o("div",re,[e[10]||(e[10]=o("label",{class:"form-label"},"Seuil d'Alerte",-1)),c(I,{modelValue:l.value.seuilAlerte,"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.seuilAlerte=t),type:"number",step:"1",placeholder:"10",id:"seuilAlerte",name:"seuilAlerte"},null,8,["modelValue"]),e[11]||(e[11]=o("small",{class:"text-muted"},"Alerte si stock < seuil",-1))])]),e[18]||(e[18]=o("h6",{class:"text-sm mt-3 mb-2"},"Tarification",-1)),o("div",ne,[o("div",ce,[e[12]||(e[12]=o("label",{class:"form-label"},"Prix d'Achat",-1)),c(I,{modelValue:l.value.prixAchat,"onUpdate:modelValue":e[4]||(e[4]=t=>l.value.prixAchat=t),type:"number",step:"0.01",placeholder:"0.00",id:"prixAchat",name:"prixAchat"},null,8,["modelValue"])]),o("div",de,[e[13]||(e[13]=o("label",{class:"form-label"},"Prix de Vente HT *",-1)),c(I,{modelValue:l.value.prixVentHT,"onUpdate:modelValue":e[5]||(e[5]=t=>l.value.prixVentHT=t),type:"number",step:"0.01",placeholder:"0.00","is-required":!0,id:"prixVentHT",name:"prixVentHT"},null,8,["modelValue"])])]),A.value!==null?(x(),_("div",ue,[o("div",me,[o("div",pe,[e[14]||(e[14]=o("strong",null,"Marge:",-1)),B(" "+U(A.value.montant.toFixed(2))+" FC ("+U(A.value.pourcentage.toFixed(1))+"%) ",1),A.value.pourcentage<0?(x(),_("span",ve," ‚ö†Ô∏è Perte !")):$("",!0)])])])):$("",!0),o("div",fe,[o("div",ge,[c(P,{modelValue:l.value.statut,"onUpdate:modelValue":e[6]||(e[6]=t=>l.value.statut=t),id:"stockStatut",name:"statut"},{default:C(()=>[...e[15]||(e[15]=[B(" Actif ",-1)])]),_:1},8,["modelValue"])])])],32)])]),_:1},8,["modal-id","title","is-loading"]))}},be=R(Se,[["__scopeId","data-v-6a13e304"]]),ye={class:"container-fluid py-4"},Ae={class:"row"},xe={class:"col-12"},ke={__name:"Stocks",setup(M){const{requireAuth:T}=G(),k=z(),{showConfirm:h,showSuccess:v,showError:y,showLoading:m,close:d}=Q();T();const p=r(!1),n=r([]),f=r(null),w=r(null),g=[{key:"numero",label:"N¬∞",type:"index",align:"center"},{key:"articleNom",label:"Article",render:(e,t)=>t.articleNom||`Article #${t.idArticle}`},{key:"siteNom",label:"Site",render:(e,t)=>t.siteNom||`Site #${t.idSite}`},{key:"categorieNom",label:"Cat√©gorie",render:(e,t)=>t.categorieNom||"-"},{key:"quantiteStock",label:"Quantit√©",align:"center",render:(e,t)=>{const a=parseFloat(e)||0,i=parseInt(t.seuilAlerte,10)||0;return a===0?'<span class="badge badge-sm bg-gradient-danger">0 - Rupture</span>':i>0&&a<=i?`<span class="badge badge-sm bg-gradient-warning">${a.toFixed(2)} - Alerte !</span>`:`<span class="badge badge-sm bg-gradient-success">${a.toFixed(2)}</span>`}},{key:"seuilAlerte",label:"Seuil",align:"center",render:e=>{const t=parseInt(e,10)||0;return t>0?t:"-"}},{key:"prix",label:"Prix Achat / Vente",render:(e,t)=>{const a=parseFloat(t.prixAchat)||0,i=parseFloat(t.prixVentHT)||0;return`
        <div style="font-size: 0.75rem;">
          <span class="text-secondary">${a.toLocaleString("fr-CD",{style:"currency",currency:"CDF"})}</span> /
          <strong class="text-success">${i.toLocaleString("fr-CD",{style:"currency",currency:"CDF"})}</strong>
        </div>
      `}},{key:"marge",label:"Marge",align:"end",render:(e,t)=>{const a=parseFloat(t.prixAchat)||0,i=parseFloat(t.prixVentHT)||0;if(a===0)return"-";const S=(i-a)/a*100;return S<0?`<span class="text-danger">${S.toFixed(1)}%</span>`:S<20?`<span class="text-warning">${S.toFixed(1)}%</span>`:`<span class="text-success font-weight-bold">${S.toFixed(1)}%</span>`}},{key:"statut",label:"Statut",align:"center",render:e=>e?'<span class="badge badge-sm bg-gradient-success">Actif</span>':'<span class="badge badge-sm bg-gradient-secondary">Inactif</span>'}],A=[{name:"toggle",label:e=>e.statut?"D√©sactiver":"Activer",icon:e=>e.statut?"fas fa-toggle-on":"fas fa-toggle-off",class:e=>e.statut?"text-success":"text-secondary",onClick:e=>F(e)},{name:"edit",label:"Modifier",icon:"fas fa-edit",class:"text-secondary",onClick:e=>N(e)},{name:"delete",label:"Supprimer",icon:"fas fa-trash",class:"text-danger",iconOnly:!0,onClick:e=>s(e)}],l=async()=>{p.value=!0,console.log("üì¶ Chargement des stocks...");try{await E();const e=n.value.filter(t=>{const a=parseFloat(t.quantiteStock)||0,i=parseInt(t.seuilAlerte,10)||0;return a===0||i>0&&a<=i});e.length>0&&console.warn(`‚ö†Ô∏è ${e.length} stock(s) en alerte !`)}catch(e){console.error("‚ùå Erreur chargement stocks:",e),await y("Erreur","Impossible de charger les stocks"),n.value=[]}finally{p.value=!1}},E=async()=>{try{const e=k.societeId||3;console.log(`üì¶ Chargement des stocks optimis√©s pour Lejecolia (#${e})`);const t=await b.getStocksVueBySociete(e);n.value=(Array.isArray(t)?t:[]).map(a=>{const i=a.articleNom||a.nomArticle||a.libelleArticle||a.libelle||a.descriptionArticle||a.article||a.designation||`Article #${a.idArticle}`,u=a.siteNom||a.nomSite||a.siteName||a.site||`Site #${a.idSite}`,S=a.categorieNom||a.nomCategorie||a.categorie||a.libelleCategorie||"";return{...a,articleNom:i,siteNom:u,categorieNom:S}}),console.log(`‚úÖ ${n.value.length} stock(s) trouv√©s pour la soci√©t√©`)}catch(e){throw console.warn("‚ö†Ô∏è Impossible de charger les stocks:",e),e}},q=()=>{f.value=null,new H(document.getElementById("stockModal")).show()},N=e=>{f.value={...e},new H(document.getElementById("stockModal")).show()},F=async e=>{const t=!e.statut,a=t?"activer":"d√©sactiver";if((await h(`${a.charAt(0).toUpperCase()+a.slice(1)} ?`,`Voulez-vous ${a} le stock de ${e.articleNom} ?`,{confirmButtonText:`Oui, ${a}`,confirmButtonColor:t?"#2dce89":"#f5365c"})).isConfirmed){m(`${a.charAt(0).toUpperCase()+a.slice(1)}...`);try{const u={...e,statut:t,idSociete:k.societeId||3};await b.updateStock(e.idStock,u),d(),await v("Modifi√© !",`Stock ${t?"activ√©":"d√©sactiv√©"}`),await l()}catch(u){d(),console.error("‚ùå Erreur:",u),await y("Erreur","Impossible de modifier le statut")}}},V=async e=>{var t,a;m("Enregistrement...");try{const i={...e,idSociete:k.societeId||3};e.idStock&&e.idStock>0?(await b.updateStock(e.idStock,i),await v("Modifi√© !","Stock modifi√©")):(await b.createStock(i),await v("Cr√©√© !","Stock cr√©√©"));const u=H.getInstance(document.getElementById("stockModal"));u&&u.hide(),await l()}catch(i){d(),console.error("‚ùå Erreur:",i),await y("Erreur",((a=(t=i.response)==null?void 0:t.data)==null?void 0:a.message)||"Erreur de sauvegarde")}},s=async e=>{if((await h("Supprimer ?",`Supprimer le stock de ${e.articleNom} au site ${e.siteNom} ?`,{confirmButtonText:"Oui, supprimer",confirmButtonColor:"#d33"})).isConfirmed){m("Suppression...");try{await b.deleteStock(e.idStock),d(),await v("Supprim√© !"),await l()}catch{d(),await y("Erreur","Impossible de supprimer")}}};return O(()=>{l()}),(e,t)=>(x(),_("div",ye,[o("div",Ae,[o("div",xe,[c(J,{title:"Gestion des Stocks",subtitle:"Inventaire et tarification des articles",data:n.value,columns:g,actions:A,"show-search":!0,"search-fields":["articleNom","siteNom"],loading:p.value,"items-per-page":10,"loading-text":"Chargement des stocks...","empty-text":"Aucun stock trouv√©"},{actions:C(()=>[c(j,{color:"success",size:"sm",onClick:q},{default:C(()=>[...t[0]||(t[0]=[o("i",{class:"fas fa-plus me-2"},null,-1),B(" Nouveau Stock ",-1)])]),_:1})]),_:1},8,["data","loading"])])]),c(be,{stock:f.value,"modal-id":"stockModal",onSave:V,ref_key:"stockModalRef",ref:w},null,8,["stock"])]))}},$e=R(ke,[["__scopeId","data-v-aea11f30"]]);export{$e as default};
